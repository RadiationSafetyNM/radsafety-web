---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import ChecklistItem from "../components/ChecklistItem.astro";
import Lightbox from "../components/Lightbox.astro";
import Icon from "../components/Icon.astro";
import { getCollection } from "astro:content";

const items = await getCollection("inspection");
const sortedItems = items.sort((a, b) => a.data.order - b.data.order);
---

<DashboardLayout title="ì •ê¸°ê²€ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸" scale={0.85}>
	<style>
		/* main width is defined in global.css */
		.intro {
			margin-bottom: 1.5rem; /* Reduced margin */
			background-color: var(--bg-card);
			padding: 0.75rem 1rem; /* Compact padding */
			border-radius: 8px;
			border: 1px solid var(--border-color);
			color: var(--text-main);
			font-size: 0.85rem;
			display: flex;
			align-items: center;
			justify-content: space-between;
			gap: 1rem;
		}
		.intro p {
			margin: 0;
			line-height: 1.4;
		}
		.reset-btn {
			background-color: #475569; /* Slate 600 - Neutral/Professional */
			color: white;
			border: none;
			padding: 0.4rem 0.8rem; /* Smaller padding */
			border-radius: 6px;
			cursor: pointer;
			font-size: 0.8rem;
			white-space: nowrap;
			flex-shrink: 0;
			transition: background-color 0.2s;
		}
		.reset-btn:hover {
			background-color: #334155;
		}
		.download-section {
			margin-top: 3rem;
			text-align: center;
			border-top: 1px solid var(--border-color);
			padding-top: 2rem;
		}
		.download-link {
			display: inline-flex;
			align-items: center;
			margin-top: 1rem;
			padding: 0.75rem 1.25rem;
			background-color: var(--bg-card);
			border: 1px solid var(--border-color);
			color: var(--text-main);
			text-decoration: none;
			border-radius: 8px;
			transition: background-color 0.2s;
			font-size: 0.9rem;
			gap: 0.5rem;
		}
		.download-link:hover {
			background-color: var(--bg-sidebar);
			border-color: var(--accent);
		}
		.download-link.secondary {
			background-color: transparent;
			border-style: dashed;
			color: var(--text-muted);
		}
		.search-container {
			position: relative;
			margin-bottom: 1.5rem;
		}
		#searchInput {
			width: 100%;
			box-sizing: border-box; /* Fix overflow issues */
			padding: 0.75rem 1rem 0.75rem 2.5rem; /* Compact padding */
			font-size: 0.9rem; /* Compact font */
			border: 1px solid var(--border-color);
			border-radius: 99px;
			box-shadow: 0 1px 2px var(--shadow-color);
			transition:
				border-color 0.2s,
				box-shadow 0.2s;
			background-color: var(--bg-card);
			color: var(--text-main);
		}
		#searchInput:focus {
			outline: none;
			border-color: var(--accent);
			box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
		}
		.search-icon {
			position: absolute;
			left: 1.25rem;
			top: 50%;
			transform: translateY(-50%);
			color: #9ca3af;
			pointer-events: none;
		}
		}
        
        /* New Layout Styles */
        .section-container {
            margin-bottom: 2.5rem;
        }
        .section-title {
            font-size: 1.25rem;
            color: var(--text-main);
            margin-bottom: 1rem;
            border-left: 4px solid var(--accent);
            padding-left: 0.75rem;
            font-weight: 700;
        }
        .info-card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            box-shadow: 0 1px 2px var(--shadow-color);
        }
        .info-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .info-desc {
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--text-main);
            margin: 0;
        }
        .accent-text {
            color: #ef4444; /* Red accent for warnings/notes */
            font-size: 0.9rem;
            font-weight: 500;
        }
        .mb-4 { margin-bottom: 1rem; }
	</style>

	<div
		style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;"
	>
		<h1
			style="font-size: 1.1rem; margin: 0; display: flex; align-items: center; gap: 0.5rem;"
		>
			<Icon name="check-square" size="20" class="inline-icon" /> RIë“± í—ˆê°€ì‚¬ìš©ì ì •ê¸°ê²€ì‚¬ ì²´í¬ë¦¬ìŠ¤íŠ¸
		</h1>
		<button id="resetBtn" class="reset-btn">ì´ˆê¸°í™” (ì„ íƒí•´ì œ)</button>
	</div>



	<div class="search-container">
		<input
			type="text"
			id="searchInput"
			placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì¢…ì‚¬ì, ê¸°ë¡)"
			aria-label="ì²´í¬ë¦¬ìŠ¤íŠ¸ ê²€ìƒ‰"
		/>
		<span class="search-icon"><Icon name="search" size="20" /></span>
	</div>

	<!-- Section 1: Cooperation Request -->
	<div class="section-container">
        <!-- Title removed from here as it becomes the accordion title? No, User said "1. ìˆ˜ê²€í˜‘ì¡°ì‚¬í•­" is the item title? 
             User said: "ìˆ˜ê²€í˜‘ì¡°ì‚¬í•­(cooperation)ì—ì„œ ë²ˆí˜¸ê°€ ì•„ë‹ˆë¼ ì²´í¬ë°•ìŠ¤ê°€ í•„ìš”í•˜ë‹¤" 
             This usually means the Header itself has the checkbox (which ChecklistItem has).
             "1ë‹¨ê³„ëŠ” í•„ì³ì € ë³´ì´ë„ë¡ í•œë‹¤" -> Default Open.
             
             Let's use "ìˆ˜ê²€í˜‘ì¡°ì‚¬í•­ (Cooperation)" as the Category or Title.
             Let's use a Generic Title or Empty?
             
             User Spec:
             Level 1: Accordion (Open)
             Content:
               [ ] ê²€ì‚¬ì›...ê³µê°„
               [ ] ë…¸íŠ¸ë¶...ê°€ëŠ¥
               [ ] ìˆ˜ê²€ ë§¤ë‰´ì–¼...ë¹„ì¹˜
               [ ] ì „ì‚°ìë£Œ...ì¤€ë¹„
        -->
		<h2 class="section-title">1. ìˆ˜ê²€í˜‘ì¡° ìš”ì²­ì‚¬í•­</h2>

		<div class="checklist-container" id="cooperationContainer">
			{
				[
					{
						id: "coop-merged",
						slug: "coop-merged",
						data: {
							order: 1,
							title: "ìˆ˜ê²€ ì¥ì†Œì™€ ìë£Œ ì¤€ë¹„", 
							category: "",
							content: `
                                <ul style="padding-left: 0.5rem; margin: 0;">
                                    <li style="list-style: none; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" /> 
                                            <span style="line-height: 1.5;">ê²€ì‚¬ì› ë° ìˆ˜ê²€ìê°€ í™œìš©í•  ìˆ˜ ìˆëŠ” íšŒì˜í…Œì´ë¸”ì´ ë§ˆë ¨ëœ ë³„ë„ ê³µê°„</span>
                                        </label>
                                    </li>
                                    <li style="list-style: none; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" /> 
                                            <span style="line-height: 1.5;">ë…¸íŠ¸ë¶ ì‚¬ìš©(ì „ì›)ì´ ê°€ëŠ¥í•œ ê³µê°„</span>
                                        </label>
                                    </li>
                                    <li style="list-style: none; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" /> 
                                            <span style="line-height: 1.5;">ìˆ˜ê²€ ë§¤ë‰´ì–¼ì— ì œì‹œëœ ìˆ˜ê²€ì— í•„ìš”í•œ ê°ì¢… ì„œë¥˜ë¥¼ ìˆ˜ê²€ì¥ì†Œì— ë¹„ì¹˜</span>
                                        </label>
                                    </li>
                                    <li style="list-style: none; margin-bottom: 0.5rem;">
                                        <label style="display: flex; align-items: flex-start; gap: 0.5rem; cursor: pointer;">
                                            <input type="checkbox" /> 
                                            <span style="line-height: 1.5;">ì „ì‚°ìë£Œì˜ ê²½ìš° ì§ì ‘ í™•ì¸ ê°€ëŠ¥í•œ PC ì¤€ë¹„</span>
                                        </label>
                                    </li>
                                </ul>
                            `,
							check: [
                                "íšŒì˜í…Œì´ë¸” ê³µê°„",
                                "ë…¸íŠ¸ë¶ ì „ì›",
                                "ì„œë¥˜ ë¹„ì¹˜",
                                "í™•ì¸ìš© PC"
                            ],
						},
					}
				].map((item) => <ChecklistItem item={item} open={true} />)
			}
		</div>
	</div>

	<!-- Section 2: Common Preparation -->
	<div class="section-container">
		<h2 class="section-title">2. ê³µí†µ ì¤€ë¹„ìë£Œ</h2>

		<div class="checklist-container" id="checklistContainer">
			{
				sortedItems
					.filter((item) => item.data.category !== "ì˜ë£Œë¶„ì•¼" && item.data.category !== "íŒë§¤ë¶„ì•¼" && item.data.category !== "ìƒì‚°ë¶„ì•¼")
					.map((item) => <ChecklistItem item={item} />)
			}
		</div>
	</div>

	<!-- Section 3: Medical Field -->
	<div class="section-container">
		<h2 class="section-title">3. ì˜ë£Œë¶„ì•¼ ì¤€ë¹„ìë£Œ</h2>
		<div class="checklist-container">
			{
				sortedItems
					.filter((item) => item.data.category === "ì˜ë£Œë¶„ì•¼")
					.map((item) => <ChecklistItem item={item} />)
			}
		</div>
	</div>

	<!-- Section 4: Sales Field -->
	<div class="section-container">
		<h2 class="section-title">4. íŒë§¤ë¶„ì•¼ ì¤€ë¹„ì„œë¥˜</h2>
		<div class="checklist-container">
			{
				sortedItems
					.filter((item) => item.data.category === "íŒë§¤ë¶„ì•¼")
					.map((item) => <ChecklistItem item={item} />)
			}
		</div>
	</div>

	<!-- Section 5: Production Field -->
	<div class="section-container">
		<h2 class="section-title">5. ìƒì‚°ë¶„ì•¼ ì¤€ë¹„ìë£Œ</h2>
		<div class="checklist-container">
			{
				sortedItems
					.filter((item) => item.data.category === "ìƒì‚°ë¶„ì•¼")
					.map((item) => <ChecklistItem item={item} />)
			}
		</div>
		
	</div>

	<div
		id="noResults"
		style="display: none; text-align: center; padding: 2rem; color: #6b7280;"
	>
		ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
	</div>

	<div class="download-section">
		<p>ì „ì²´ ë‚´ìš©ì„ ì›ë³¸ìœ¼ë¡œ í™•ì¸í•˜ì‹œë ¤ë©´ PDFë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.</p>
		<div
			class="button-group"
			style="display:flex; justify-content:center; gap:0.5rem; flex-wrap:wrap;"
		>
			<a
				href="/archive/ë°©ì‚¬ì„ ë¶„ì•¼ ì •ê¸°ê²€ì‚¬ìˆ˜ê²€ê°€ì´ë“œ(2022ë…„ ê°œì •)_ìµœì¢…ë³¸.pdf"
				class="download-link"
				target="_blank"
			>
				ğŸ‘ï¸ ì›ë³¸ ê°€ì´ë“œ ë³´ê¸° (PDF)
			</a>
			<a
				href="/archive/ë°©ì‚¬ì„ ë¶„ì•¼ ì •ê¸°ê²€ì‚¬ìˆ˜ê²€ê°€ì´ë“œ(2022ë…„ ê°œì •)_ìµœì¢…ë³¸.pdf"
				class="download-link secondary"
				download
			>
				ğŸ’¾ ë‹¤ìš´ë¡œë“œ
			</a>
		</div>
	</div>

	<Lightbox />

	<script>
		document.addEventListener("astro:page-load", () => {
			initChecklistLogic();
		});

		// Fallback
		if (document.readyState !== "loading") {
			initChecklistLogic();
		}

		function initChecklistLogic() {
			// Restore state logic
			const initializeState = () => {
				document.querySelectorAll(".checklist-item").forEach((item) => {
					const id = item.dataset.id;
					const panel = item.querySelector(".panel");
					const subCheckboxes = panel.querySelectorAll(
						'input[type="checkbox"]',
					);
					const mainCheckbox = item.querySelector(".status-checkbox");
					const progressText = item.querySelector(".progress-text");

					// Restore Sub Checkboxes
					subCheckboxes.forEach((cb, idx) => {
						// Enable them
						cb.removeAttribute("disabled");
						cb.style.cursor = "pointer";

						const subKey = `inspection-${id}-sub-${idx}`;
						if (localStorage.getItem(subKey) === "checked") {
							cb.checked = true;
						}
					});

					// Restore Main Checkbox
					const mainState = localStorage.getItem(`inspection-${id}`);
					if (mainState === "checked") {
						item.classList.add("checked");
						mainCheckbox.checked = true;
					}

					updateMainCheckboxUI(item);
				});
			};

			const updateMainCheckboxUI = (item) => {
				const id = item.dataset.id;
				const panel = item.querySelector(".panel");
				const mainCheckbox = item.querySelector(".status-checkbox");
				const progressText = item.querySelector(".progress-text");
				const subCheckboxes = panel.querySelectorAll(
					'input[type="checkbox"]',
				);

				const total = subCheckboxes.length;
				if (total === 0) return;

				const checkedCount = Array.from(subCheckboxes).filter(
					(cb) => cb.checked,
				).length;
				const allChecked = checkedCount === total;

				if (progressText)
					progressText.textContent = `(${checkedCount}/${total})`;

				// Sync Main state if needed (optional logic: auto-check main)
				if (allChecked) {
					item.classList.add("checked");
					mainCheckbox.checked = true;
					localStorage.setItem(`inspection-${id}`, "checked");
				} else {
					// Only uncheck main if it was auto-synced?
					// Let's keep strict sync: if not all checked, main is unchecked?
					// User logic: Main checkbox is master toggle.
					const mainState = localStorage.getItem(`inspection-${id}`);
					if (mainState === "checked" && checkedCount < total) {
						// If user manually unchecked a sub, main should uncheck?
						// Yes.
						item.classList.remove("checked");
						mainCheckbox.checked = false;
						localStorage.removeItem(`inspection-${id}`);
					}
				}
			};

			initializeState();

			// SEARCH LOGIC
			document
				.getElementById("resetBtn")
				?.addEventListener("click", () => {
					if (confirm("ëª¨ë“  ì²´í¬ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
						localStorage.clear();
						window.location.reload();
					}
				});

			const searchInput = document.getElementById("searchInput");
			const noResults = document.getElementById("noResults");

			if (searchInput) {
				searchInput.addEventListener("input", (e) => {
					const term = e.target.value.toLowerCase().trim();
					const items = document.querySelectorAll(".checklist-item");
					let hasResults = false;

					items.forEach((item) => {
						const title =
							item.querySelector(".title")?.textContent || "";
						const content =
							item.querySelector(".content")?.textContent || "";
						const text = (title + " " + content).toLowerCase();

						if (text.includes(term)) {
							item.style.display = "";
							hasResults = true;
						} else {
							item.style.display = "none";
						}
					});

					if (!hasResults && term !== "") {
						if (noResults) noResults.style.display = "block";
					} else {
						if (noResults) noResults.style.display = "none";
					}
				});
			}

			// GLOBAL DELEGATION FOR CLICK EVENTS
			// Bind to document body or loop through containers to ensure new sections work
			// Using document body delegation is safest if containers might change, but class selection is fine here.
			
			const containers = document.querySelectorAll(".checklist-container");
			containers.forEach(container => {
				container.onclick = (e) => {
					const target = e.target;

					// 1. Accordion Toggle (Click on Header or Button)
					// Target any click within .header that is NOT a checkbox or label for checkbox
					const header = target.closest(".header");
					const isCheckbox =
						target.closest(".checkbox-container") ||
						target.matches("input[type='checkbox']");

					if (header && !isCheckbox) {
						const item = header.closest(".checklist-item");
						const panel = item.querySelector(".panel");
						const isOpen = panel.classList.contains("open");

						if (!isOpen) {
							panel.classList.add("open");
							panel.style.display = "block";
							item.classList.add("open");
						} else {
							panel.classList.remove("open");
							panel.style.display = "none";
							item.classList.remove("open");
						}
						return;
					}

					// 2. Main Checkbox Toggle
					if (target.matches(".status-checkbox")) {
						const item = target.closest(".checklist-item");
						const isChecked = target.checked;
						const id = item.dataset.id;
						const panel = item.querySelector(".panel");
						const subCheckboxes = panel.querySelectorAll(
							'input[type="checkbox"]',
						);

						if (isChecked) {
							item.classList.add("checked");
							localStorage.setItem(`inspection-${id}`, "checked");
							// Check all subs
							subCheckboxes.forEach((cb, idx) => {
								cb.checked = true;
								localStorage.setItem(
									`inspection-${id}-sub-${idx}`,
									"checked",
								);
							});
						} else {
							item.classList.remove("checked");
							localStorage.removeItem(`inspection-${id}`);
							// Uncheck all subs
							subCheckboxes.forEach((cb, idx) => {
								cb.checked = false;
								localStorage.removeItem(
									`inspection-${id}-sub-${idx}`,
								);
							});
						}
						updateMainCheckboxUI(item);
						return;
					}

					// 3. Sub Checkbox Toggle (inside panel)
					if (target.matches('.panel input[type="checkbox"]')) {
						const item = target.closest(".checklist-item");
						const id = item.dataset.id;
						// Find index?
						const panel = item.querySelector(".panel");
						const subCheckboxes = Array.from(
							panel.querySelectorAll('input[type="checkbox"]'),
						);
						const idx = subCheckboxes.indexOf(target);

						if (idx !== -1) {
							if (target.checked) {
								localStorage.setItem(
									`inspection-${id}-sub-${idx}`,
									"checked",
								);
							} else {
								localStorage.removeItem(
									`inspection-${id}-sub-${idx}`,
								);
							}
							updateMainCheckboxUI(item);
						}
						return;
					}

					// 4. Example Toggle
					const exBtn = target.closest(".example-toggle-btn");
					if (exBtn) {
						const wrapper = exBtn.closest(".example-wrapper");
						const content =
							wrapper.querySelector(".example-content");
						const isVisible = content.style.display === "block";
						content.style.display = isVisible ? "none" : "block";

						const iconSvg =
							'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z M14 2v6h6 M16 13H8 M16 17H8 M10 9H8"></path></svg>';
						exBtn.innerHTML = isVisible
							? `<span class="icon">${iconSvg}</span> ì˜ˆì‹œì„œë¥˜ ë³´ê¸°`
							: `<span class="icon">${iconSvg}</span> ì˜ˆì‹œì„œë¥˜ ì ‘ê¸°`;
						return;
					}
				};
			});
		}
	</script>
</DashboardLayout>
