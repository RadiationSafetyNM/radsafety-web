---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<DashboardLayout title="ë§ˆì´í˜ì´ì§€">
    <style>
        .mypage-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding-bottom: 4rem;
        }

        /* 1. Profile Section */
        .profile-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); /* Soft shadow */
        }
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--border-color);
        }
        .profile-info {
            flex: 1;
        }
        .profile-name {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0 0 0.25rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .profile-email {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.8rem;
            font-weight: 600;
            gap: 0.25rem;
        }
        .badge-verified {
            background: linear-gradient(
                135deg,
                #ffd700 0%,
                #fdb931 100%
            ); /* Gold Gradient */
            color: #7b5800;
            border: 1px solid #eebb11;
        }
        .badge-unverified {
            background: #f3f4f6;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
        }
        .badge-unverified:hover {
            background: #e5e7eb;
            color: #374151;
        }

        /* 2. Dashboard Section (Grid) */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        .dash-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            transition: transform 0.2s;
        }
        .dash-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
        }
        .dash-title {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dash-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-main);
        }
        .progress-bar {
            height: 6px;
            background: #f3f4f6;
            border-radius: 99px;
            margin-top: 1rem;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 1s ease-out;
        }

        /* 3. Section Headers */
        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 1.5rem 0 0.75rem 0;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* 4. Menu List */
        .menu-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }
        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
            text-decoration: none;
            color: var(--text-main);
        }
        .menu-item:last-child {
            border-bottom: none;
        }
        .menu-item:hover {
            background: var(--bg-body);
        }
        .menu-icon {
            margin-right: 0.75rem;
            color: var(--text-muted);
        }

        /* Modal for Verification */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-card {
            background: white;
            width: 90%;
            max-width: 400px;
            padding: 2rem;
            border-radius: 16px;
            text-align: center;
        }

        @media (max-width: 600px) {
            .profile-card {
                flex-direction: column;
                text-align: center;
            }
            .profile-name {
                justify-content: center;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <div class="mypage-container">
        <!-- 1. Identity Section -->
        <div class="profile-card">
            <div class="profile-avatar" id="userAvatar">ğŸ§‘â€âš•ï¸</div>
            <div class="profile-info">
                <h2 class="profile-name">
                    <span id="userName">ê¹€í•µì˜</span>
                    <!-- Verified Badge (Hidden by default) -->
                    <span
                        id="badgeVerified"
                        class="badge badge-verified"
                        style="display:none;"
                    >
                        ğŸ‘‘ ëŒ€í•œí•µì˜í•™íšŒ ì •íšŒì›
                    </span>
                    <!-- Unverified Action (Visible by default) -->
                    <button id="btnVerifyParams" class="badge badge-unverified">
                        âš¡ í•™íšŒì› ì¸ì¦í•˜ê¸°
                    </button>
                </h2>
                <div class="profile-email" id="userEmail">
                    doctor@hospital.or.kr
                </div>
                <div
                    style="font-size:0.8rem; color:var(--text-muted); margin-top:0.25rem;"
                >
                    ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì¤‘
                </div>
            </div>
        </div>

        <!-- 2. Dashboard Section -->
        <div class="dashboard-grid">
            <div class="dash-card">
                <div class="dash-title">ìˆ˜ê²€ ì²´í¬ë¦¬ìŠ¤íŠ¸ ì§„í–‰ë¥  ğŸ“</div>
                <div class="dash-value">45%</div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 45%;"></div>
                </div>
                <div
                    style="font-size:0.8rem; margin-top:0.5rem; color:var(--text-muted);"
                >
                    ì´ 98ê°œ í•­ëª© ì¤‘ 44ê°œ ì™„ë£Œ
                </div>
            </div>
            <div class="dash-card">
                <div class="dash-title">ë‚˜ì˜ ë“±ë¡ ìë£Œ ğŸ“‚</div>
                <div class="dash-value">3ê±´</div>
                <div
                    style="font-size:0.8rem; margin-top:0.5rem; color:var(--text-muted);"
                >
                    ìµœê·¼ ë“±ë¡: ì•ˆì „ê´€ë¦¬ê·œì • (2025.10.12)
                </div>
            </div>
        </div>

        <!-- 3. My Activity -->
        <div>
            <div class="section-title">ë‚˜ì˜ í™œë™</div>
            <div class="menu-list">
                <a href="/resources?filter=my" class="menu-item">
                    <span>ğŸ“‚ ë‚´ê°€ ì˜¬ë¦° ìë£Œ ê´€ë¦¬</span>
                    <span>â€º</span>
                </a>
                <a href="#" class="menu-item">
                    <span>ğŸ’¬ ë‚´ê°€ ë³´ë‚¸ ì˜ê²¬/ë¬¸ì˜</span>
                    <span>â€º</span>
                </a>
            </div>
        </div>

        <!-- 4. Settings -->
        <div>
            <div class="section-title">ì„¤ì •</div>
            <div class="menu-list">
                <div class="menu-item">
                    <span>ğŸ”” ì¹´ì¹´ì˜¤ ì•Œë¦¼í†¡ ìˆ˜ì‹ </span>
                    <label
                        style="position:relative; display:inline-block; width:40px; height:24px;"
                    >
                        <input
                            type="checkbox"
                            checked
                            style="opacity:0; width:0; height:0;"
                        />
                        <span
                            style="position:absolute; cursor:pointer; top:0; left:0; right:0; bottom:0; background-color:#ccc; transition:.4s; border-radius:34px;"
                        ></span>
                        <span
                            style="position:absolute; content:''; height:16px; width:16px; left:4px; bottom:4px; background-color:white; transition:.4s; border-radius:50%; transform: translateX(16px); background-color: white;"
                        ></span>
                        <!-- Mock Toggle ON style via JS needed actually, simplified here -->
                        <span
                            style="font-size:0.8rem; color:#2563eb; font-weight:bold; margin-left:10px;"
                            >ON</span
                        >
                    </label>
                </div>
                <button
                    id="logoutBtnBody"
                    class="menu-item"
                    style="width:100%; background:white; border:none; text-align:left;"
                >
                    <span style="color:#ef4444;">ë¡œê·¸ì•„ì›ƒ</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Verification Modal -->
    <div id="verifyModal" class="modal-overlay">
        <div class="modal-card">
            <h3 style="font-size:1.2rem; margin-bottom:1rem;">í•™íšŒì› ì¸ì¦</h3>
            <p style="color:#6b7280; margin-bottom:1.5rem; font-size:0.9rem;">
                ëŒ€í•œí•µì˜í•™íšŒ/ê¸°ìˆ í•™íšŒì— ë“±ë¡ëœ<br />ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.
            </p>
            <input
                type="email"
                placeholder="example@hospital.or.kr"
                style="width:100%; padding:0.75rem; border:1px solid #d1d5db; border-radius:8px; margin-bottom:1rem;"
            />
            <div style="display:flex; gap:0.5rem;">
                <button
                    id="closeVerifyBtn"
                    style="flex:1; padding:0.75rem; background:#f3f4f6; border:none; border-radius:8px;"
                    >ë‹«ê¸°</button
                >
                <button
                    style="flex:1; padding:0.75rem; background:var(--accent); color:white; border:none; border-radius:8px;"
                    >ì¸ì¦ ìš”ì²­</button
                >
            </div>
        </div>
    </div>

    <script>
        import { userProfile } from "../store/user";
        import { supabase } from "../lib/supabase";

        // *** DEVELOPMENT MOCK DATA ***
        // If no user logic found, force this mock user for Design Review
        const MOCK_USER = {
            email: "preview@test.com",
            full_name: "ë¯¸ë¦¬ë³´ê¸°(ê¹€í•µì˜)",
            is_approved: false, // Toggle to true to see verified state
        };
        // *****************************

        document.addEventListener("astro:page-load", () => {
            // Subscription
            userProfile.subscribe((user) => {
                // For Design Review: If User is null, use MOCK_USER
                const displayUser = user || MOCK_USER;

                updateMyPageUI(displayUser);
            });

            // Modal Logic
            const modal = document.getElementById("verifyModal");
            const btnOpen = document.getElementById("btnVerifyParams");
            const btnClose = document.getElementById("closeVerifyBtn");

            btnOpen?.addEventListener("click", () =>
                modal?.classList.add("active"),
            );
            btnClose?.addEventListener("click", () =>
                modal?.classList.remove("active"),
            );

            // Logout
            document
                .getElementById("logoutBtnBody")
                ?.addEventListener("click", async () => {
                    if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        await supabase.auth.signOut();
                        userProfile.set(null);
                        window.location.href = "/";
                    }
                });
        });

        function updateMyPageUI(user) {
            if (!user) return; // Should not happen with mock

            document.getElementById("userName").textContent =
                user.full_name || "ì‚¬ìš©ì";
            document.getElementById("userEmail").textContent =
                user.email || "-";

            const badgeVerified = document.getElementById("badgeVerified");
            const btnVerify = document.getElementById("btnVerifyParams");

            if (user.is_approved === "true" || user.is_verified) {
                // Handle string/bool
                badgeVerified.style.display = "inline-flex";
                if (btnVerify) btnVerify.style.display = "none";
            } else {
                badgeVerified.style.display = "none";
                if (btnVerify) btnVerify.style.display = "inline-flex";
            }
        }
    </script>
</DashboardLayout>
