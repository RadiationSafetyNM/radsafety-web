---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import Icon from "../components/Icon.astro"; // Import Icon component
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<DashboardLayout title="마이페이지">
    <style>
        .mypage-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            padding-bottom: 4rem;
        }

        /* Common Card Style */
        .info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .section-title-text {
            font-size: 1.05rem; /* Slightly smaller */
            font-weight: 700;
            color: var(--text-main);
        }

        /* 1. Identity Section specific */
        .identity-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            width: 100%;
            justify-content: space-between; /* Space out Login Badge and Admin Badge */
        }

        .login-badge {
            font-size: 0.75rem;
            padding: 0.15rem 0.5rem;
            border-radius: 99px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-weight: 600;
        }
        .kakao-badge {
            background: #fee500;
            color: #3c1e1e;
        }
        .email-badge {
            background: #e5e7eb;
            color: #374151;
        }

        .info-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.4rem 0; /* Reduced padding */
            border-bottom: 1px solid #f3f4f6;
        }
        .info-row:last-child {
            border-bottom: none;
        }

        .info-label {
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        .info-value {
            color: var(--text-main);
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* 3. Safety Info specific */
        .safety-item {
            background: transparent;
            padding: 0.6rem;
            border-radius: 8px; /* Match radio radius */
            border: 1px solid #e5e7eb;
            margin-bottom: 0.4rem;
            transition: all 0.2s;
        }
        .safety-item:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        .safety-item:has(input:checked) {
            border: 2px solid var(--accent);
            padding: calc(0.75rem - 1px);
        }
        .safety-item:has(input:checked) .safety-title {
            color: var(--accent);
        }
        .safety-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .safety-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-main);
            margin: 0;
        }
        .safety-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin: 0.15rem 0 0 0;
        }
        .app-toggle {
            width: 1.1rem;
            height: 1.1rem;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .radio-option {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.6rem;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s;
        }
        .radio-option:hover {
            background: rgba(0, 0, 0, 0.02);
        }
        .radio-option:has(input:checked) {
            border: 2px solid var(--accent);
            padding: calc(
                0.6rem - 1px
            ); /* Adjustment for border width difference */
            background: transparent;
        }
        .radio-option:has(input:checked) .radio-title {
            color: var(--accent);
        }
        .radio-label {
            display: flex;
            flex-direction: column;
        }
        .radio-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--text-main);
        }
        .radio-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-card {
            background: white;
            width: 90%;
            max-width: 500px;
            padding: 2rem;
            border-radius: 16px;
        }
        .tab-btn.active {
            border-bottom-color: var(--accent) !important;
            color: var(--accent) !important;
            font-weight: bold;
        }
    </style>

    <div class="mypage-container">
        <!-- 1. Identity Section -->
        <div class="info-card">
            <div class="section-header">
                <div class="identity-header">
                    <!-- Login Status Badge -->
                    <div id="loginBadge" class="login-badge email-badge">
                        <Icon name="user" size="14" />
                        <span>로그인 중</span>
                    </div>
                    <!-- Admin Badge (moved here) -->
                    <div
                        id="adminBadge"
                        style="display:none; font-size:0.75rem; background:#ef4444; color:white; padding:0.15rem 0.5rem; border-radius:12px; font-weight:bold; letter-spacing:0.5px;"
                    >
                        ADMIN
                    </div>
                </div>
            </div>

            <div
                style="margin-top:0.5rem; font-size:0.9rem; color:var(--text-main); display: flex; justify-content: space-between; align-items: center;"
            >
                <div>
                    <span
                        id="userIdentityName"
                        style="font-weight:700; margin-right:0.5rem;">...</span
                    >
                    <span
                        id="userIdentityEmail"
                        style="color:var(--text-muted);">...</span
                    >
                </div>
                <span style="color:#6b7280; font-size:0.85rem;"
                    >가입일: <span id="userJoinedAt" style="font-weight:500;"
                        >...</span
                    ></span
                >
            </div>
        </div>

        <!-- 1. Identity & Login Method Card -->
        <div class="info-card">
            <div
                class="section-header"
                style="justify-content: space-between; align-items: center;"
            >
                <div style="display:flex; align-items:baseline; gap:0.5rem;">
                    <span class="section-title-text"
                        >인증형태: <span
                            id="userVerificationType"
                            style="color:var(--accent);">...</span
                        ></span
                    >
                </div>
                <div style="font-size:0.85rem; color:var(--text-muted);">
                    인증일: <span
                        id="userVerificationDate"
                        style="color:var(--text-main); font-weight:600;">-</span
                    >
                </div>
            </div>

            <div
                style="display:grid; grid-template-columns: 1fr 1fr; gap:0.5rem;"
            >
                <label class="radio-option">
                    <input
                        type="radio"
                        name="authType"
                        value="nuclear_medicine"
                        style="accent-color:var(--accent);"
                    />
                    <div class="radio-label">
                        <span class="radio-title">대한핵의학회</span>
                    </div>
                </label>
                <label class="radio-option">
                    <input
                        type="radio"
                        name="authType"
                        value="technology"
                        style="accent-color:var(--accent);"
                    />
                    <div class="radio-label">
                        <span class="radio-title">대한핵의학기술학회</span>
                    </div>
                </label>
                <label class="radio-option">
                    <input
                        type="radio"
                        name="authType"
                        value="special"
                        style="accent-color:var(--accent);"
                    />
                    <div class="radio-label">
                        <span class="radio-title"
                            >특별사용자 <span
                                style="color:var(--accent); font-weight:normal; font-size:1.3rem; vertical-align:sub; line-height:0;"
                                >*</span
                            ></span
                        >
                    </div>
                </label>
                <label class="radio-option">
                    <input
                        type="radio"
                        name="authType"
                        value="none"
                        style="accent-color:var(--text-muted);"
                    />
                    <div class="radio-label">
                        <span class="radio-title">인증 요청 안함</span>
                    </div>
                </label>
            </div>
            <p
                style="font-size: 0.8rem; color: var(--text-muted); margin-top: 0; display: flex; align-items: center; gap: 4px;"
            >
                <span
                    style="color:var(--accent); font-size: 1.3rem; line-height: 0; vertical-align: sub;"
                    >*</span
                > 학회 비소속 방사선안전관리자 등이 앱관리자에게 하는 요청
            </p>

            <!-- Verified Info Display Area (Appears inside this card) -->
            <div
                id="societyInfoContent"
                style="display:none; margin-top:0.5rem; padding-top:0.5rem; border-top:1px dashed #e5e7eb;"
            >
                <div
                    style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:1rem;"
                >
                    <h5
                        style="margin:0; font-size:0.95rem; color:var(--accent);"
                    >
                        인증된 정보
                    </h5>
                    <button
                        id="reverifyBtn"
                        style="
                            display: inline-flex;
                            align-items: center;
                            gap: 0.3rem;
                            padding: 0.35rem 0.75rem;
                            background: var(--accent);
                            color: white;
                            border: none;
                            border-radius: 6px;
                            font-size: 0.8rem;
                            font-weight: 500;
                            cursor: pointer;
                            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
                            transition: all 0.2s;
                        "
                        onmouseover="this.style.opacity='0.9'"
                        onmouseout="this.style.opacity='1'"
                    >
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="12"
                            height="12"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2.5"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            ><path d="M23 4v6h-6"></path><path
                                d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"
                            ></path></svg
                        >
                        정보 갱신
                    </button>
                </div>

                <div
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1rem;"
                >
                    <div
                        class="info-row"
                        style="border:none; padding: 0.2rem 0;"
                    >
                        <span class="info-label" style="min-width: 40px;"
                            >학회</span
                        >
                        <span id="userSocietyName" class="info-value">...</span>
                    </div>
                    <div
                        class="info-row"
                        style="border:none; padding: 0.2rem 0;"
                    >
                        <span class="info-label" style="min-width: 40px;"
                            >구분</span
                        >
                        <span id="userSocietyRole" class="info-value">...</span>
                    </div>
                    <div
                        class="info-row"
                        style="border:none; padding: 0.2rem 0;"
                    >
                        <span class="info-label" style="min-width: 40px;"
                            >이름</span
                        >
                        <span id="userRealName" class="info-value">...</span>
                    </div>
                    <div
                        class="info-row"
                        style="border:none; padding: 0.2rem 0;"
                    >
                        <span class="info-label" style="min-width: 40px;"
                            >이메일</span
                        >
                        <span
                            id="userSocietyEmail"
                            class="info-value"
                            style="font-size:0.85rem;">...</span
                        >
                    </div>
                    <div
                        class="info-row"
                        style="border:none; padding: 0.2rem 0; min-width: 0;"
                    >
                        <span class="info-label" style="min-width: 40px;"
                            >기관</span
                        >
                        <span
                            id="userAffiliation"
                            class="info-value"
                            style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; text-align: right;"
                            >...</span
                        >
                    </div>
                    <div
                        class="info-row"
                        style="border:none; padding: 0.2rem 0;"
                    >
                        <span class="info-label" style="min-width: 40px;"
                            >부서</span
                        >
                        <span id="userDepartment" class="info-value">...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Radiation Safety Info Section -->
        <div class="info-card">
            <div class="section-header">
                <span class="section-title-text">방사선안전관리 정보</span>
            </div>

            <!-- Safety Cards Grid -->
            <div
                style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;"
            >
                <!-- A. License Holder -->
                <div class="safety-item">
                    <h5 class="safety-title" style="margin-bottom: 0.5rem;">
                        방사선안전관리면허
                    </h5>
                    <select
                        id="radLicenseSelect"
                        class="app-select"
                        style="width: 100%; padding: 0.4rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 0.9rem;"
                    >
                        <option value="none">관련면허없음</option>
                        <option value="supervisor">RI취급자감독자면허</option>
                        <option value="special">RI취급자특수면허</option>
                        <option value="general">RI취급자일반면허</option>
                    </select>
                </div>

                <!-- B. Safety Manager (Official) -->
                <div class="safety-item">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center;"
                    >
                        <h5 class="safety-title" style="margin: 0;">
                            방사선안전관리자
                        </h5>
                        <input
                            type="checkbox"
                            id="managerToggle"
                            class="app-toggle"
                        />
                    </div>
                    <!-- Year Range Display (shows after save) -->
                    <div
                        id="managerYearDisplay"
                        style="display:none; margin-top:0.5rem; font-size:0.9rem; color:var(--text-muted);"
                    >
                    </div>
                    <!-- Date Inputs -->
                    <div
                        id="managerDates"
                        style="display:none; margin-top:1rem; padding-top:1rem; border-top:1px dashed #d1d5db;"
                    >
                        <div
                            style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;"
                        >
                            <div>
                                <label
                                    style="display:block; font-size:0.85rem; font-weight:600; color:var(--text-muted); margin-bottom:0.5rem;"
                                    >시작년도</label
                                >
                                <input
                                    type="number"
                                    id="managerStartDate"
                                    placeholder="예: 2020"
                                    min="1900"
                                    max="2100"
                                    style="width:100%; padding:0.5rem; border:1px solid #d1d5db; border-radius:6px; font-size:0.9rem;"
                                />
                            </div>
                            <div>
                                <label
                                    style="display:block; font-size:0.85rem; font-weight:600; color:var(--text-muted); margin-bottom:0.5rem;"
                                    >종료년도</label
                                >
                                <input
                                    type="number"
                                    id="managerEndDate"
                                    placeholder="예: 2025"
                                    min="1900"
                                    max="2100"
                                    style="width:100%; padding:0.5rem; border:1px solid #d1d5db; border-radius:6px; font-size:0.9rem;"
                                />
                            </div>
                        </div>
                        <label
                            style="display: inline-flex; align-items: center; margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-muted); cursor: pointer; white-space: nowrap;"
                        >
                            <input
                                type="checkbox"
                                id="startDateUnknown"
                                style="margin-right: 0.3rem; flex-shrink: 0;"
                            />
                            시작년도 기억나지 않음
                        </label>
                        <button
                            id="saveManagerBtn"
                            style="margin-top:1rem; width:100%; padding:0.6rem; background:var(--accent); color:white; border:none; border-radius:6px; font-weight:600; cursor:pointer;"
                            >저장하기</button
                        >
                    </div>
                </div>

                <!-- C. Deputy Safety Manager -->
                <div class="safety-item">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center;"
                    >
                        <h5 class="safety-title" style="margin: 0;">
                            방안관리자 대리자
                        </h5>
                        <input
                            type="checkbox"
                            id="deputyToggle"
                            class="app-toggle"
                        />
                    </div>
                </div>

                <!-- D. Practical Staff -->
                <div class="safety-item">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center;"
                    >
                        <h5 class="safety-title" style="margin: 0;">
                            방안관리 실무담당
                        </h5>
                        <input
                            type="checkbox"
                            id="practiceToggle"
                            class="app-toggle"
                        />
                    </div>
                </div>
            </div>
        </div>
    </div>
</DashboardLayout>

<!-- Verification Modal (Reused) -->
<div id="verifyModal" class="modal-overlay">
    <div class="modal-card">
        <h3 style="font-size:1.3rem; margin-bottom:1.5rem;">회원 인증</h3>

        <div
            class="tab-nav"
            style="display:flex; border-bottom:2px solid #e5e7eb; margin-bottom:1.5rem;"
            data-cache-bust="2026-02-08-v2"
        >
            <button
                class="tab-btn active"
                data-tab="auto"
                style="flex:1; padding:0.75rem; border:none; background:none; cursor:pointer; border-bottom:2px solid var(--accent); font-weight:bold; color:var(--accent);"
                >학회원 명부로 인증진행</button
            >
            <button
                class="tab-btn"
                data-tab="society"
                style="flex:1; padding:0.75rem; border:none; background:none; cursor:pointer; color:#6b7280;"
                >앱관리자에게 인증신청</button
            >
            <button
                class="tab-btn"
                data-tab="special"
                style="flex:1; padding:0.75rem; border:none; background:none; cursor:pointer; color:#6b7280;"
                >특별사용자</button
            >
        </div>

        <!-- Tab 1: Auto -->
        <div class="tab-content" data-tab="auto">
            <p style="color:#6b7280; margin-bottom:1rem;">
                학회 명단에 등록된 이메일을 입력하세요.<br />
                <span style="font-size: 0.9em; color: #ef4444;"
                    >* 학회로부터 제공받은 명부에 누락되어 인증이 되지 않으면,
                    상단의 [앱관리자에게 인증신청] 탭을 이용하여 인증을
                    요청하세요.</span
                >
            </p>
            <input
                id="verificationEmail"
                type="email"
                placeholder="example@hospital.or.kr"
                style="width:100%; padding:0.75rem; border:1px solid #d1d5db; border-radius:8px; margin-bottom:1rem;"
            />
            <div style="display:flex; gap:0.5rem;">
                <button
                    class="close-modal-btn"
                    style="flex:1; padding:0.75rem; background:#f3f4f6; border:none; border-radius:8px; cursor:pointer;"
                    >닫기</button
                >
                <button
                    id="confirmVerifyBtn"
                    style="flex:1; padding:0.75rem; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer;"
                    >인증 요청</button
                >
            </div>
        </div>

        <!-- Tab 2: Manual Society -->
        <div class="tab-content" data-tab="society" style="display:none;">
            <p style="color:#6b7280; margin-bottom:1rem; font-size:0.9rem;">
                명단에 없는 경우 관리자 승인을 통해 인증받을 수 있습니다.
            </p>
            <form
                id="societyRequestForm"
                style="display:flex; flex-direction:column; gap:1rem;"
            >
                <input
                    name="full_name"
                    type="text"
                    placeholder="이름 (실명)"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <select
                    name="society"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                >
                    <option value="">학회 선택</option>
                    <option value="nuclear_medicine">대한핵의학회</option>
                    <option value="technology">대한핵의학기술학회</option>
                </select>
                <input
                    name="affiliation"
                    type="text"
                    placeholder="근무 기관"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="department"
                    type="text"
                    placeholder="부서"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="classification"
                    type="text"
                    placeholder="구분 (전문의/방사선사/핵과학자/전공의/임상병리사/기타)"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="contact_email"
                    type="email"
                    placeholder="연락처 이메일"
                    required
                    autocomplete="email"
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <textarea
                    name="reason"
                    rows="2"
                    placeholder="신청 사유 (예: 명단 누락)"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                ></textarea>
                <div style="display:flex; gap:0.5rem;">
                    <button
                        type="button"
                        class="close-modal-btn"
                        style="flex:1; padding:0.75rem; background:#f3f4f6; border:none; border-radius:8px; cursor:pointer;"
                        >닫기</button
                    >
                    <button
                        type="submit"
                        style="flex:1; padding:0.75rem; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer;"
                        >신청하기</button
                    >
                </div>
            </form>
        </div>

        <!-- Tab 3: Special -->
        <div class="tab-content" data-tab="special" style="display:none;">
            <p style="color:#6b7280; margin-bottom:1rem; font-size:0.9rem;">
                규제기관 등 특별 권한이 필요한 경우 신청하세요.
            </p>
            <form
                id="specialRequestForm"
                style="display:flex; flex-direction:column; gap:1rem;"
            >
                <input
                    name="full_name"
                    type="text"
                    placeholder="이름"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="affiliation"
                    type="text"
                    placeholder="근무 기관"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="department"
                    type="text"
                    placeholder="부서"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="classification"
                    type="text"
                    placeholder="구분 (전문의/방사선사/핵과학자/전공의/임상병리사/기타)"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <input
                    name="contact_email"
                    type="email"
                    placeholder="연락처 이메일"
                    required
                    autocomplete="email"
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                />
                <textarea
                    name="reason"
                    rows="2"
                    placeholder="신청 사유"
                    required
                    style="padding:0.75rem; border:1px solid #d1d5db; border-radius:8px;"
                ></textarea>
                <div style="display:flex; gap:0.5rem;">
                    <button
                        type="button"
                        class="close-modal-btn"
                        style="flex:1; padding:0.75rem; background:#f3f4f6; border:none; border-radius:8px; cursor:pointer;"
                        >닫기</button
                    >
                    <button
                        type="submit"
                        style="flex:1; padding:0.75rem; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer;"
                        >신청하기</button
                    >
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Account Section -->
    <div
        style="margin-top: 3rem; text-align: center; border-top: 1px solid #eee; padding-top: 1rem;"
    >
        <button
            id="deleteAccountBtn"
            style="background: none; border: none; color: #9ca3af; text-decoration: underline; cursor: pointer; font-size: 0.8rem;"
        >
            회원 탈퇴
        </button>
    </div>
</div>

<script>
    import { userProfile } from "../store/user";
    import { supabase } from "../lib/supabase";

    console.log("Mypage script loaded");
    document.addEventListener("astro:page-load", async () => {
        console.log("Mypage astro:page-load fired");

        // Subscribe to store changes to handle async updates from DashboardLayout
        userProfile.subscribe(async (currentUser) => {
            if (!currentUser.id) return; // Wait for ID

            // --- 1. Identity Render ---
            const loginBadge = document.getElementById("loginBadge");
            if (loginBadge) {
                if (currentUser.provider === "kakao") {
                    loginBadge.className = "login-badge kakao-badge";
                    loginBadge.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3C6.48 3 2 6.48 2 10.76c0 2.76 1.87 5.2 4.76 6.55-.21.78-.77 2.82-.88 3.23-.14.53.19.52.4.34.17-.14 2.65-1.8 3.71-2.53.64.09 1.31.14 2.01.14 5.52 0 10-3.48 10-7.76S17.52 3 12 3z"/></svg> <span>카카오 로그인 중</span>`;
                } else {
                    loginBadge.className = "login-badge email-badge";
                    loginBadge.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg> <span>이메일 로그인 중</span>`;
                }
            }

            const nameEl = document.getElementById("userIdentityName");
            const emailEl = document.getElementById("userIdentityEmail");
            if (nameEl)
                nameEl.textContent =
                    currentUser.society_name ||
                    currentUser.nickname ||
                    "이름 없음";
            if (emailEl)
                emailEl.textContent =
                    currentUser.login_email || currentUser.email || "-";

            // Joined At Format
            const dateEl = document.getElementById("userJoinedAt");
            if (dateEl) {
                if (currentUser.created_at) {
                    try {
                        const joinedDate = new Date(currentUser.created_at);
                        dateEl.textContent =
                            joinedDate.toLocaleDateString("ko-KR");
                    } catch (e) {
                        dateEl.textContent = "-";
                    }
                } else {
                    dateEl.textContent = "-";
                }
            }

            // Verification Date
            const vDateEl = document.getElementById("userVerificationDate");
            if (vDateEl) {
                if (currentUser.verified_date) {
                    const d = new Date(currentUser.verified_date);
                    vDateEl.textContent = `${d.getFullYear()}.${String(d.getMonth() + 1).padStart(2, "0")}.${String(d.getDate()).padStart(2, "0")}`;
                } else {
                    vDateEl.textContent = "-";
                }
            }

            // Admin Badge
            const adminBadge = document.getElementById("adminBadge");
            if (adminBadge) {
                if (String(currentUser.is_admin) === "true") {
                    adminBadge.style.display = "block";
                } else {
                    adminBadge.style.display = "none";
                }
            }

            // --- 2. Verification (Radio) Logic ---
            const radios = document.getElementsByName("authType");
            const societyInfoContent =
                document.getElementById("societyInfoContent");
            const userVerificationType = document.getElementById(
                "userVerificationType",
            );

            // 1. Set Initial UI State based on verification_type
            let currentType = "none";
            const vType = currentUser.verification_type || "none";

            // Map DB value to Readable Text
            const vTypeMap = {
                none: "미인증",
                society_list: "학회명부인증",
                admin: "앱관리자인증",
            };
            if (userVerificationType) {
                userVerificationType.textContent = vTypeMap[vType] || vType;
            }

            // Determine Radio State
            if (vType !== "none") {
                if (currentUser.member_type === "special")
                    currentType = "special";
                else if (currentUser.society === "nuclear_medicine")
                    currentType = "nuclear_medicine";
                else if (currentUser.society === "technology")
                    currentType = "technology";
                // If verified but legacy, might default to something else?
                // For now, if no specific society match, maybe just don't check any radio or keep 'none' if inconsistent.
            }

            // Show/Hide Verified Info
            if (vType === "society_list" || vType === "admin") {
                if (societyInfoContent) {
                    societyInfoContent.style.display = "block";
                    const societyMap = {
                        nuclear_medicine: "대한핵의학회",
                        technology: "대한핵의학기술학회",
                    };
                    document.getElementById("userSocietyName").textContent =
                        societyMap[currentUser.society] ||
                        currentUser.society ||
                        "-";
                    document.getElementById("userSocietyRole").textContent =
                        currentUser.society_role || "-";
                    document.getElementById("userRealName").textContent =
                        currentUser.society_name ||
                        currentUser.full_name ||
                        "-";
                    document.getElementById("userSocietyEmail").textContent =
                        currentUser.society_email || currentUser.email || "-";
                    document.getElementById("userAffiliation").textContent =
                        currentUser.affiliation || "-";
                    document.getElementById("userDepartment").textContent =
                        currentUser.department || "-";
                }
            } else {
                if (societyInfoContent) {
                    societyInfoContent.style.display = "none";
                }
            }

            // Update Radio UI
            radios.forEach((r) => {
                if (r.value === currentType) r.checked = true;
            });

            // 3. Radio Event Listener
            radios.forEach((r) => {
                r.addEventListener("change", async (e) => {
                    const currentUser = userProfile.get();
                    const selected = e.target.value;
                    const vType = currentUser.verification_type || "none";

                    // Determine current active radio based on stored state (to revert if needed)
                    let activeRadioVal = "none";
                    if (vType === "society_list") {
                        // Map back to radio values if possible, though 'society_list' maps to 'society' member_type usually
                        if (currentUser.member_type === "society") {
                            if (currentUser.society === "nuclear_medicine")
                                activeRadioVal = "nuclear_medicine";
                            else if (currentUser.society === "technology")
                                activeRadioVal = "technology";
                        }
                    } else if (vType === "admin") {
                        // Admin verification might not directly map to these radios easily without more specific fields
                        // But usually admin verification is for special users?
                        if (currentUser.member_type === "special")
                            activeRadioVal = "special";
                    }

                    if (selected === activeRadioVal) return; // No change based on current stored state (idealistic)

                    if (selected === "none") {
                        if (
                            confirm(
                                "인증 정보를 해제하시겠습니까? (회원 권한이 일반회원으로 변경됩니다)",
                            )
                        ) {
                            try {
                                const { error } = await supabase
                                    .from("profiles")
                                    .update({
                                        verification_type: "none",
                                        member_type: "general",
                                        is_approved: false, // Access might be revoked
                                        society: null,
                                        society_email: null,
                                        society_name: null,
                                        society_role: null,
                                        affiliation: null,
                                        department: null,
                                    })
                                    .eq("id", currentUser.id);

                                if (error) throw error;

                                userProfile.set({
                                    ...currentUser,
                                    verification_type: "none",
                                    member_type: "general",
                                    is_approved: "false",
                                    society: "",
                                    society_email: "",
                                    society_name: "",
                                    society_role: "",
                                    affiliation: "",
                                    department: "",
                                });
                                alert("인증 정보가 해제되었습니다.");
                            } catch (err) {
                                alert("오류 발생: " + err.message);
                                // Revert UI
                                e.target.checked = false;
                                // Ideally select the correct one
                            }
                        } else {
                            // Revert
                            e.target.checked = false;
                        }
                        return;
                    }

                    // Show Modal for new verification structure
                    // For society (nuclear_medicine / technology) -> default tab 'auto'
                    // For special -> default tab 'special' (mapped in modal logic below)

                    const modal = document.getElementById("verifyModal");
                    const tabBtns = document.querySelectorAll(".tab-btn");
                    const tabContents =
                        document.querySelectorAll(".tab-content");

                    modal.classList.add("active");

                    // Set Initial Tab based on selection
                    let targetTab = "auto";
                    // If special user selected, show 'Request to Admin' tab directly?
                    // Or keep default 'auto' (society list) and let them switch?
                    // Original requirement: "앱관리자에게 인증요청" is the 2nd tab ("manual").
                    // "Special" user implies manual verification.

                    // Logic:
                    // If nuclear/technology selected -> Tab 'auto' (List check) is primary.
                    // If special selected -> Tab 'special' (Manual) is primary?
                    // Wait, the tabs in HTML are generally: 'auto' (society list), 'manual' (society request), 'special' (special user request).

                    // Let's refine based on HTML structure (assumed):
                    // Tab 1: data-tab="auto" (Society List Check)
                    // Tab 2: data-tab="society" (Society Manual Request)
                    // Tab 3: data-tab="special" (Special User Request)

                    if (selected === "special") {
                        targetTab = "special";
                    } else {
                        targetTab = "auto";
                    }

                    // Activate Tab
                    tabBtns.forEach((b) => {
                        if (b.dataset.tab === targetTab)
                            b.classList.add("active");
                        else b.classList.remove("active");
                    });
                    tabContents.forEach((c) => {
                        if (c.dataset.tab === targetTab)
                            c.style.display = "block";
                        else c.style.display = "none";
                    });
                });
            });

            // Modal Close & Tab Listeners (Added)
            const modal = document.getElementById("verifyModal");
            const closeBtns = document.querySelectorAll(".close-modal-btn");
            const tabBtns = document.querySelectorAll(".tab-btn");
            const tabContents = document.querySelectorAll(".tab-content");

            // Close Buttons
            closeBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    modal.classList.remove("active");
                    // Reset forms if needed?
                });
            });

            // Tab Switching
            tabBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const target = btn.dataset.tab;

                    // Update Buttons
                    tabBtns.forEach((b) => b.classList.remove("active"));
                    btn.classList.add("active");

                    // Update Content
                    tabContents.forEach((c) => {
                        if (c.dataset.tab === target) c.style.display = "block";
                        else c.style.display = "none";
                    });
                });
            });

            // Close on click outside
            window.addEventListener("click", (e) => {
                if (e.target === modal) {
                    modal.classList.remove("active");
                }
            });

            // ... (Rest of safety info logic - Toggle Listeners) ...

            // Auto Verification Submit (Updated for verification_type)
            document
                .getElementById("confirmVerifyBtn")
                ?.addEventListener("click", async (e) => {
                    const currentUser = userProfile.get();
                    const emailInput =
                        document.getElementById("verificationEmail");
                    const email = emailInput.value.trim();
                    if (!email) return alert("이메일을 입력해주세요.");

                    const btn = e.target;
                    btn.textContent = "확인 중...";
                    btn.disabled = true;

                    try {
                        // 1. Check allowed_members
                        const { data: allowedData, error } = await supabase
                            .from("allowed_members")
                            .select("*")
                            .eq("email", email)
                            .single();

                        if (error || !allowedData)
                            throw new Error("명단에서 찾을 수 없습니다.");

                        // 2. Update Profile
                        const updateData = {
                            verification_type: "society_list", // New Field
                            verified_at: new Date().toISOString(), // Keep if needed for history? Or rely on updated_at?
                            verified_date: new Date().toISOString(),

                            member_type: "society", // user_tier -> member_type
                            society: allowedData.society,
                            society_email: email,
                            society_name:
                                allowedData.name || allowedData.full_name, // Handle variation if any
                            department: allowedData.department,
                            affiliation: allowedData.affiliation,
                            society_role:
                                allowedData.classification || allowedData.role,
                        };

                        const { error: updateError } = await supabase
                            .from("profiles")
                            .update(updateData)
                            .eq("id", currentUser.id);

                        if (updateError) throw updateError;

                        // 3. Update Store
                        userProfile.set({
                            ...currentUser,
                            ...updateData,
                            verification_type: "society_list",
                            member_type: "society",
                        });

                        alert("✅ 인증되었습니다!");
                        document
                            .getElementById("verifyModal")
                            .classList.remove("active");
                        // window.location.reload(); // Not needed needed if store reactive? But safe.
                    } catch (err) {
                        if (err.message.includes("명단에서 찾을 수 없습니다")) {
                            if (
                                confirm(
                                    "학회 명단에 없거나 정보가 일치하지 않습니다.\n[앱관리자에게 인증신청] 탭으로 이동하시겠습니까?",
                                )
                            ) {
                                document
                                    .querySelector(
                                        '.tab-btn[data-tab="society"]',
                                    )
                                    ?.click();
                            }
                        } else {
                            alert("인증 실패: " + err.message);
                        }
                    } finally {
                        btn.textContent = "인증 요청";
                        btn.disabled = false;
                    }
                });

            // Manual Forms (Updated for verification_type)
            [
                { id: "societyRequestForm", type: "society" },
                { id: "specialRequestForm", type: "special" },
            ].forEach(({ id, type }) => {
                const formEl = document.getElementById(id);
                if (formEl) {
                    // Use onsubmit to prevent multiple listeners stacking
                    formEl.onsubmit = async (e) => {
                        e.preventDefault();
                        const currentUser = userProfile.get();
                        const form = e.target;
                        const formData = new FormData(form);
                        const btn = form.querySelector('button[type="submit"]');

                        btn.textContent = "신청 중...";
                        btn.disabled = true;

                        try {
                            const reqData = {
                                user_id: currentUser.id,
                                type: type, // 'society' or 'special'
                                full_name: formData.get("full_name"),
                                affiliation: formData.get("affiliation"),
                                department: formData.get("department"),
                                classification: formData.get("classification"),
                                email: formData.get("contact_email"),
                                reason: formData.get("reason"),
                                status: "approved", // Auto-approved provisionally
                            };

                            if (type === "society") {
                                reqData.society = formData.get("society");
                            }

                            // 1. Insert Request
                            const { error } = await supabase
                                .from("verification_requests")
                                .insert(reqData);

                            if (error) throw error;

                            // 2. Profile Update (Immediate Provisional Approval)
                            const updateData = {
                                verified_date: new Date().toISOString(),
                                verification_type: "admin", // Provisionally approved as admin override
                                member_type: type, // 'society' or 'special'
                                is_approved: true,
                            };

                            // Map form fields to profile fields
                            if (type === "society") {
                                updateData.society = formData.get("society");
                                updateData.society_name =
                                    formData.get("full_name");
                                updateData.affiliation =
                                    formData.get("affiliation");
                                updateData.department =
                                    formData.get("department");
                                updateData.classification =
                                    formData.get("classification");
                                updateData.society_email =
                                    formData.get("contact_email");
                            } else if (type === "special") {
                                updateData.society_name =
                                    formData.get("full_name");
                                updateData.affiliation =
                                    formData.get("affiliation");
                                updateData.department =
                                    formData.get("department");
                                updateData.classification =
                                    formData.get("classification");
                                updateData.society_email =
                                    formData.get("contact_email");
                            }

                            const { error: profileError } = await supabase
                                .from("profiles")
                                .update(updateData)
                                .eq("id", currentUser.id);

                            if (profileError) throw profileError;

                            // Update Store
                            userProfile.set({
                                ...currentUser,
                                ...updateData,
                            });

                            alert(
                                "✅ 일단 자동으로 승인되었습니다. 추후 관리자 검토 결과에 따라 승인이 취소될 수도 있습니다.",
                            );
                            form.reset();
                            document
                                .getElementById("verifyModal")
                                .classList.remove("active");
                        } catch (err) {
                            console.error(err);
                            alert("신청 실패: " + err.message);
                        } finally {
                            btn.textContent = "신청하기";
                            btn.disabled = false;
                        }
                    };
                }
            });

            // Logout
            document
                .getElementById("logoutBtn")
                ?.addEventListener("click", async () => {
                    const { error } = await supabase.auth.signOut();
                    if (error) alert(error.message);
                    else window.location.href = "/login";
                });

            // Delete Account
            document
                .getElementById("deleteAccountBtn")
                ?.addEventListener("click", async () => {
                    if (
                        !confirm(
                            "정말로 탈퇴하시겠습니까?\n\n- 계정 정보는 즉시 삭제됩니다.\n- 작성하신 게시글(지적/권고, 자료실 등)은 '알 수 없음'으로 남게 됩니다.\n- 이 작업은 되돌릴 수 없습니다.",
                        )
                    )
                        return;

                    try {
                        const { error } =
                            await supabase.rpc("delete_own_account");
                        if (error) throw error;

                        await supabase.auth.signOut();
                        alert(
                            "탈퇴가 완료되었습니다. 이용해 주셔서 감사합니다.",
                        );
                        window.location.href = "/";
                    } catch (err) {
                        console.error(err);
                        alert(
                            "탈퇴 처리 중 오류가 발생했습니다: " + err.message,
                        );
                    }
                });
        });
    });
</script>
