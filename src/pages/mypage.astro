---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<DashboardLayout title="ë§ˆì´í˜ì´ì§€">
    <style>
        .profile-container {
            max-width: 720px;
            margin: 0 auto;
            padding: 2rem 0;
        }
        .profile-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-shadow: 0 1px 3px var(--shadow-color);
        }
        .avatar {
            width: 80px;
            height: 80px;
            background: var(--bg-body);
            border-radius: 50%;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border: 1px solid var(--border-color);
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 0.5rem;
        }
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #fbbf24;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        .status-approved {
            background: rgba(16, 185, 129, 0.1);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .info-grid {
            width: 100%;
            margin-top: 2rem;
            text-align: left;
            border-top: 1px solid var(--border-color);
            padding-top: 1.5rem;
        }
        .info-item {
            margin-bottom: 1rem;
        }
        .label {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
        .value {
            font-size: 1rem;
            color: var(--text-main);
            font-weight: 500;
        }

        #logoutBtn {
            margin-top: 2rem;
            padding: 0.5rem 1.5rem;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>

    <div class="profile-container">
        <h1>ë§ˆì´í˜ì´ì§€</h1>

        <div id="loading" style="text-align:center;">ë¡œë”© ì¤‘...</div>

        <div id="profileContent" class="profile-card" style="display:none;">
            <div class="avatar">ğŸ‘¤</div>
            <h2 id="userName">ì‚¬ìš©ì ì´ë¦„</h2>
            <div id="userEmail" style="color:#6b7280;">email@example.com</div>

            <div id="statusBadge" class="status-badge status-pending">
                ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ (ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”)
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="label">ë¡œê·¸ì¸ ì œê³µì</div>
                    <div class="value" id="provider">Google</div>
                </div>
            </div>

            <button id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
        </div>

        <div id="guestContent" style="display:none; text-align:center;">
            <p>ë¡œê·¸ì¸ëœ ì‚¬ìš©ìê°€ ì•„ë‹™ë‹ˆë‹¤.</p>
            <a
                href="/radsafety/login"
                style="display:inline-block; margin-top:1rem; padding:0.5rem 1rem; background:#2563eb; color:white; border-radius:6px; text-decoration:none;"
                >ë¡œê·¸ì¸ í•˜ëŸ¬ ê°€ê¸°</a
            >
        </div>
    </div>

    <script>
        import { userProfile, clearUser } from "../store/user";
        import { supabase } from "../lib/supabase";

        function updateUI(user) {
            const loading = document.getElementById("loading");
            const profile = document.getElementById("profileContent");
            const guest = document.getElementById("guestContent");

            // Hide Loading
            if (loading) loading.style.display = "none";

            if (user && user.email) {
                // Logged In
                if (profile) profile.style.display = "flex";
                if (guest) guest.style.display = "none";

                const nameEl = document.getElementById("userName");
                const emailEl = document.getElementById("userEmail");
                const provEl = document.getElementById("provider");

                if (nameEl) nameEl.textContent = user.full_name || "ì‚¬ìš©ì";
                if (emailEl) emailEl.textContent = user.email;
                if (provEl) provEl.textContent = user.provider || "SNS";

                const badge = document.getElementById("statusBadge");
                if (badge) {
                    if (user.is_approved === "true") {
                        badge.textContent = "âœ… ì •íšŒì› (ìŠ¹ì¸ ì™„ë£Œ)";
                        badge.className = "status-badge status-approved";
                    } else {
                        badge.textContent =
                            "â³ ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ (ê´€ë¦¬ì í™•ì¸ í•„ìš”)";
                        badge.className = "status-badge status-pending";
                    }
                }
            } else {
                // Guest
                if (profile) profile.style.display = "none";
                if (guest) guest.style.display = "block";
            }
        }

        function initMyPage() {
            // Subscribe to store updates
            userProfile.subscribe((user) => {
                updateUI(user);
            });

            // Check real session
            supabase.auth
                .getSession()
                .then(async ({ data: { session } }) => {
                    if (session?.user) {
                        const { user } = session;

                        // Optimistic UI update first
                        userProfile.set({
                            ...userProfile.get(),
                            id: user.id,
                            email: user.email,
                        });

                        // Fetch additional profile data
                        const { data: profile } = await supabase
                            .from("profiles")
                            .select("is_approved, full_name, avatar_url")
                            .eq("id", user.id)
                            .single();

                        const isApproved = profile?.is_approved
                            ? "true"
                            : "false";

                        userProfile.set({
                            id: user.id,
                            email: user.email,
                            full_name:
                                profile?.full_name ||
                                user.user_metadata.full_name ||
                                "ì‚¬ìš©ì",
                            avatar_url:
                                profile?.avatar_url ||
                                user.user_metadata.avatar_url,
                            provider: user.app_metadata.provider || "sns",
                            is_approved: isApproved,
                        });
                    } else {
                        clearUser(); // Only clear if strictly no session
                        updateUI(null); // Force guest UI
                    }
                })
                .catch((err) => {
                    console.error("Auth Error:", err);
                    updateUI(null); // Fallback to guest
                });

            // Fallback: If loading takes > 2s, force guest view
            setTimeout(() => {
                const loading = document.getElementById("loading");
                if (loading && loading.style.display !== "none") {
                    updateUI(null);
                }
            }, 2000);

            // Logout Handler
            const logoutBtn = document.getElementById("logoutBtn");
            if (logoutBtn) {
                // Remove old listeners to prevent duplicates if any
                const newBtn = logoutBtn.cloneNode(true);
                logoutBtn.parentNode.replaceChild(newBtn, logoutBtn);

                newBtn.addEventListener("click", async () => {
                    if (confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        await supabase.auth.signOut();
                        clearUser();
                        window.location.href = "/radsafety";
                    }
                });
            }
        }

        // Run on page load (support ViewTransitions)
        document.addEventListener("astro:page-load", initMyPage);
        // Initial load check
        // Astro ViewTransitions typically handles this with astro:page-load
    </script>
</DashboardLayout>
