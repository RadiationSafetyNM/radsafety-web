---
import BaseHead from "../components/BaseHead.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import LoginButton from "../components/auth/LoginButton.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<!doctype html>
<html lang="ko">
    <head>
        <BaseHead
            title={`ë¡œê·¸ì¸ - ${SITE_TITLE}`}
            description={SITE_DESCRIPTION}
        />
        <style>
            main {
                width: 480px;
                max-width: 100%;
                margin: 0 auto;
                padding: 4rem 1rem;
                text-align: center;
            }
            .login-container {
                background: white;
                padding: 2.5rem;
                border-radius: 12px;
                box-shadow:
                    0 4px 6px -1px rgba(0, 0, 0, 0.1),
                    0 2px 4px -1px rgba(0, 0, 0, 0.06);
                border: 1px solid #e5e7eb;
            }
            h1 {
                margin-bottom: 0.5rem;
                font-size: 1.8rem;
                color: #111827;
            }
            p.subtitle {
                color: #6b7280;
                margin-bottom: 2rem;
            }
            .divider {
                display: flex;
                align-items: center;
                text-align: center;
                margin: 1.5rem 0;
                color: #9ca3af;
                font-size: 0.9rem;
            }
            .divider::before,
            .divider::after {
                content: "";
                flex: 1;
                border-bottom: 1px solid #e5e7eb;
            }
            .divider::before {
                margin-right: 0.5em;
            }
            .divider::after {
                margin-left: 0.5em;
            }

            .test-login {
                margin-top: 1rem;
                padding: 0.5rem;
                background: #f3f4f6;
                border-radius: 4px;
                font-size: 0.85rem;
                color: #4b5563;
            }
            #mockLoginBtn {
                margin-top: 0.5rem;
                background: #4b5563;
                color: white;
                border: none;
                padding: 0.5rem 1rem;
                border-radius: 4px;
                cursor: pointer;
            }

            /* Email Login Styles */
            .email-login-section {
                margin-bottom: 2rem;
            }
            .email-form {
                display: flex;
                flex-direction: column;
                gap: 0.5rem;
            }
            .email-form input {
                padding: 0.75rem;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                font-size: 1rem;
            }
            .email-btn {
                background: #111827;
                color: white;
                padding: 0.75rem;
                border: none;
                border-radius: 6px;
                font-size: 1rem;
                font-weight: 500;
                cursor: pointer;
                transition: background 0.2s;
            }
            .email-btn:hover {
                background: #374151;
            }
            .helper-text {
                font-size: 0.85rem;
                color: #6b7280;
                margin-top: 0.5rem;
            }

            .sns-buttons {
                margin-top: 1rem;
            }
        </style>
    </head>
    <body>
        <Header />
        <main>
            <div class="login-container">
                <h1>ë¡œê·¸ì¸</h1>
                <p class="subtitle">
                    ë°©ì‚¬ì„ ì•ˆì „ê´€ë¦¬ ë„ìš°ë¯¸ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.
                </p>

                <div class="email-login-section">
                    <form id="emailLoginForm" class="email-form">
                        <input
                            type="email"
                            id="emailInput"
                            placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                            required
                        />
                        <button type="submit" class="email-btn"
                            >ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ (ë§¤ì§ë§í¬)</button
                        >
                    </form>
                    <p class="helper-text">
                        ì…ë ¥í•œ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.
                    </p>
                </div>

                <div class="divider">ë˜ëŠ” SNS ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸</div>

                <!-- SNS Buttons Wrapper -->
                <div class="sns-buttons">
                    <LoginButton
                        provider="naver"
                        label="ë„¤ì´ë²„ë¡œ ì‹œì‘í•˜ê¸°"
                        color="#03C75A"
                        textColor="white"
                        icon="ğŸ‡³"
                    />
                    <!-- ... other buttons ... -->
                    <LoginButton
                        provider="kakao"
                        label="ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°"
                        color="#FEE500"
                        textColor="#000000"
                        icon="ğŸ‡°"
                    />
                    <LoginButton
                        provider="google"
                        label="Googleë¡œ ê³„ì •ìœ¼ë¡œ ê³„ì†í•˜ê¸°"
                        color="#4285F4"
                        textColor="white"
                        icon="ğŸ‡¬"
                    />
                    <LoginButton
                        provider="facebook"
                        label="Facebookìœ¼ë¡œ ê³„ì†í•˜ê¸°"
                        color="#1877F2"
                        textColor="white"
                        icon="ğŸ‡«"
                    />
                    <LoginButton
                        provider="apple"
                        label="Appleë¡œ ê³„ì†í•˜ê¸°"
                        color="#000000"
                        textColor="white"
                        icon="ğŸ"
                    />

                    <div class="divider">ë˜ëŠ”</div>

                    <div class="test-login">
                        <p>í…ŒìŠ¤íŠ¸ìš© ëª¨ì˜ ë¡œê·¸ì¸ (DB ì—°ë™ ì „)</p>
                        <button id="mockLoginBtn"
                            >ê´€ë¦¬ì ìŠ¹ì¸ ëŒ€ê¸° ê³„ì •ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì ‘ì†</button
                        >
                        <button
                            id="mockLoginApprovedBtn"
                            style="background:#059669; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; margin-left:5px;"
                            >ìŠ¹ì¸ ì™„ë£Œ ê³„ì •ìœ¼ë¡œ ì ‘ì†</button
                        >
                    </div>
                </div>
            </div>
            <Footer />

            <script>
                import { userProfile } from "../store/user";
                import { supabase } from "../lib/supabase";

                // Mock Login Logic
                const mockLogin = (isApproved) => {
                    userProfile.set({
                        id: "mock-user-123",
                        email: isApproved
                            ? "admin@radsafety.com"
                            : "newuser@example.com",
                        full_name: isApproved ? "ê¹€ê´€ë¦¬" : "í™ê¸¸ë™",
                        avatar_url: "",
                        provider: "google",
                        is_approved: isApproved ? "true" : "false", // 'false' needs admin approval
                    });
                    alert("ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. (Mock)");
                    window.location.href = "/radsafety/mypage";
                };

                document
                    .getElementById("mockLoginBtn")
                    ?.addEventListener("click", () => mockLogin(false));
                document
                    .getElementById("mockLoginApprovedBtn")
                    ?.addEventListener("click", () => mockLogin(true));

                // Email Login Logic (Magic Link)
                const emailForm = document.getElementById("emailLoginForm");
                emailForm?.addEventListener("submit", async (e) => {
                    e.preventDefault();
                    const email = document.getElementById("emailInput").value;
                    const btn = emailForm.querySelector("button");

                    btn.disabled = true;
                    btn.textContent = "ì „ì†¡ ì¤‘...";

                    try {
                        const { error } = await supabase.auth.signInWithOtp({
                            email: email,
                            options: {
                                emailRedirectTo: `${window.location.origin}/radsafety/mypage`,
                            },
                        });

                        if (error) throw error;
                        alert(
                            "ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!\në©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
                        );
                    } catch (err) {
                        alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                    } finally {
                        btn.disabled = false;
                        btn.textContent = "ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ (ë§¤ì§ë§í¬)";
                    }
                });

                // Real Logic
                const btns = document.querySelectorAll(".login-btn");
                btns.forEach((btn) => {
                    btn.addEventListener("click", async () => {
                        const provider = btn.dataset.provider;
                        const { data, error } =
                            await supabase.auth.signInWithOAuth({
                                provider: provider,
                                options: {
                                    redirectTo: `${window.location.origin}/radsafety/mypage`,
                                },
                            });
                        if (error) alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + error.message);
                    });
                });

                // Mock Logic (Optional: Keep for admin testing if needed, or hide)
                document.querySelector(".test-login").style.display = "none";
            </script>
        </main>
    </body>
</html>
