---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import LoginButton from "../components/auth/LoginButton.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<DashboardLayout title="간편인증으로 시작하기">
    <style>
        .login-wrapper {
            max-width: 440px;
            margin: 1rem auto; /* 바짝 붙임 */
            text-align: center;
        }
        .login-container {
            background: white;
            padding: 1.25rem; /* Reduced padding */
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        h1 {
            margin-bottom: 0.25rem;
            font-size: 1.5rem; /* Smaller */
            color: var(--accent);
            font-weight: 800;
        }
        p.subtitle {
            color: #6b7280;
            margin-bottom: 1rem; /* Reduced */
            font-size: 0.85rem;
        }
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 0.75rem 0; /* Tightened */
            color: #9ca3af;
            font-size: 0.8rem;
        }
        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .divider::before {
            margin-right: 0.5em;
        }
        .divider::after {
            margin-left: 0.5em;
        }

        .test-login {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #4b5563;
        }
        #mockLoginBtn {
            margin-top: 0.5rem;
            background: #4b5563;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Email Login Styles */
        .email-login-section {
            margin-bottom: 1rem;
        }
        .email-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .email-form input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        .email-btn {
            background: #111827;
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .email-btn:hover {
            background: #374151;
        }
        .helper-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .sns-buttons {
            margin-top: 1rem;
        }

        @media (max-width: 380px) {
            .email-btn {
                font-size: 0.85rem;
                padding: 0.75rem 0.5rem;
            }
        }
    </style>

    <div class="login-wrapper">
        <div class="login-container">
            <!-- SNS Buttons Wrapper -->
            <div class="sns-buttons">
                <LoginButton
                    provider="kakao"
                    label="카카오 인증으로 RadSafety 시작하기"
                    color="#FEE500"
                    textColor="#000000"
                />
            </div>

            <div class="divider">또는 이메일 인증으로 시작하기</div>

            <div class="email-login-section">
                <form id="emailLoginForm" class="email-form">
                    <input
                        type="email"
                        id="emailInput"
                        placeholder="이메일 주소를 입력하세요"
                        required
                    />
                    <button type="submit" class="email-btn"
                        >이메일 인증으로 RadSafety 시작하기</button
                    >
                </form>
            </div>

            <div class="divider">개발용 기능</div>

            <div class="test-login">
                <div style="margin-bottom:0.5rem;">[개발자 모드]</div>
                <div
                    style="display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;"
                >
                    <button id="mockLoginBtn">대기 계정</button>
                    <button
                        id="mockLoginApprovedBtn"
                        style="background:#059669; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;"
                        >완료 계정</button
                    >
                    <button
                        id="resetSessionBtn"
                        style="background:#dc2626; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer;"
                        >세션 초기화(로그아웃)</button
                    >
                </div>
            </div>
        </div>
    </div>

    <script>
        import { userProfile, setUser, clearUser } from "../store/user";
        import { supabase } from "../lib/supabase";

        // Mock Login Logic
        const mockLogin = (isApproved) => {
            const user = {
                id: "mock-user-123",
                email: isApproved
                    ? "admin@radsafety.com"
                    : "newuser@example.com",
                full_name: isApproved ? "김관리" : "홍길동",
                avatar_url: "",
                provider: "google",
            };
            setUser(user);

            alert(
                "로그인되었습니다. (Mock Role: " +
                    (isApproved ? "Admin" : "User") +
                    ")",
            );
            window.location.href = "/mypage";
        };

        document
            .getElementById("mockLoginBtn")
            ?.addEventListener("click", () => mockLogin(false));
        document
            .getElementById("mockLoginApprovedBtn")
            ?.addEventListener("click", () => mockLogin(true));

        // Session Reset Logic
        document
            .getElementById("resetSessionBtn")
            ?.addEventListener("click", async () => {
                if (
                    confirm(
                        "모든 로그인 정보와 캐시를 초기화하고 로그아웃 하시겠습니까?",
                    )
                ) {
                    try {
                        // 1. Clear Nano Stores (User Profile)
                        clearUser();

                        // 2. Supabase Logout
                        await supabase.auth.signOut();

                        // 3. Clear All Storage
                        localStorage.clear();
                        sessionStorage.clear();

                        // 4. Clear Cookie (Optional but safe)
                        document.cookie.split(";").forEach((c) => {
                            document.cookie = c
                                .replace(/^ +/, "")
                                .replace(
                                    /=.*/,
                                    "=;expires=" +
                                        new Date().toUTCString() +
                                        ";path=/",
                                );
                        });

                        alert("세션이 성공적으로 초기화되었습니다.");
                        window.location.reload();
                    } catch (err) {
                        alert("초기화 중 오류 발생: " + err.message);
                    }
                }
            });

        // Email Login Logic (Magic Link)
        const emailForm = document.getElementById("emailLoginForm");
        emailForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("emailInput").value;
            const btn = emailForm.querySelector("button");

            btn.disabled = true;
            btn.textContent = "전송 중...";

            try {
                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: `${window.location.origin}/mypage`,
                    },
                });

                if (error) throw error;
                alert(
                    "이메일로 로그인 링크를 보냈습니다!\n메일함을 확인해주세요.",
                );
            } catch (err) {
                alert("오류 발생: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "이메일로 로그인 (매직링크)";
            }
        });

        // Real Logic
        const btns = document.querySelectorAll(".login-btn");
        btns.forEach((btn) => {
            btn.addEventListener("click", async () => {
                const provider = btn.dataset.provider;
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback`,
                        // Force override scope using queryParams (Supabase sometimes ignores 'scopes' prop)
                        queryParams: {
                            scope: "account_email,profile_nickname", // Request Email explicitly!
                        },
                    },
                });
                if (error) alert("로그인 오류: " + error.message);
            });
        });

        // Mock Logic (Visible for smartphone testing if needed)
        // document.querySelector(".test-login").style.display = "none";
    </script>
</DashboardLayout>
