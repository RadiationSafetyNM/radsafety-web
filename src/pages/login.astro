---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import LoginButton from "../components/auth/LoginButton.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";
---

<DashboardLayout title="ê°„í¸ì¸ì¦ìœ¼ë¡œ ì‹œì‘í•˜ê¸°">
    <style>
        .login-wrapper {
            max-width: 480px;
            margin: 4rem auto;
            text-align: center;
        }
        .login-container {
            background: white;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow:
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }
        h1 {
            margin-bottom: 0.5rem;
            font-size: 1.8rem;
            color: var(--accent); /* Blue for visibility */
            font-weight: 800;
        }
        p.subtitle {
            color: #6b7280;
            margin-bottom: 2rem;
        }
        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 1.5rem 0;
            color: #9ca3af;
            font-size: 0.9rem;
        }
        .divider::before,
        .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .divider::before {
            margin-right: 0.5em;
        }
        .divider::after {
            margin-left: 0.5em;
        }

        .test-login {
            margin-top: 1rem;
            padding: 0.5rem;
            background: #f3f4f6;
            border-radius: 4px;
            font-size: 0.85rem;
            color: #4b5563;
        }
        #mockLoginBtn {
            margin-top: 0.5rem;
            background: #4b5563;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Email Login Styles */
        .email-login-section {
            margin-bottom: 2rem;
        }
        .email-form {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .email-form input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }
        .email-btn {
            background: #111827;
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }
        .email-btn:hover {
            background: #374151;
        }
        .helper-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .sns-buttons {
            margin-top: 1rem;
        }
    </style>

    <div class="login-wrapper">
        <div class="login-container">
            <h1>ê°„í¸ì¸ì¦ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</h1>
            <p class="subtitle">
                RadSafety ì•± ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´ ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.
            </p>

            <!-- Guidance Text Above Button -->
            <p
                style="font-size: 0.9rem; color: #4b5563; margin-bottom: 1.5rem; line-height: 1.6; word-break: keep-all;"
            >
                ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ì‹œë©´ <strong>ë³„ë„ì˜ ê°€ì… ì ˆì°¨ ì—†ì´</strong> ë¹ ë¥´ê³ 
                ê°„í¸í•˜ê²Œ ì´ìš©í•  ìˆ˜ ìˆìœ¼ë©°, ìë™ ë¡œê·¸ì¸ìœ¼ë¡œ <strong
                    >ì¬ì ‘ì†ë„ í¸ë¦¬</strong
                >í•©ë‹ˆë‹¤.
            </p>

            <!-- SNS Buttons Wrapper -->
            <div class="sns-buttons">
                <LoginButton
                    provider="kakao"
                    label="ì¹´ì¹´ì˜¤ë¡œ ì‹œì‘í•˜ê¸°"
                    color="#FEE500"
                    textColor="#000000"
                />
            </div>

            <!-- Post-Login Verification Notice -->
            <div
                style="margin-top: 1.5rem; text-align: center; background: #f3f4f6; padding: 1rem; border-radius: 8px;"
            >
                <p
                    style="font-size: 0.85rem; color: #6b7280; margin: 0; line-height: 1.5; word-break: keep-all;"
                >
                    ğŸ’¡ <strong>í•™íšŒì› ì¸ì¦</strong>ì€ ë¡œê·¸ì¸ í›„,
                    [ë§ˆì´í˜ì´ì§€]ì—ì„œ<br />
                    ë³„ë„ì˜ ì´ë©”ì¼ë¡œ í¸ë¦¬í•˜ê²Œ ì§„í–‰í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>

            <div class="divider">ë˜ëŠ” ì´ë©”ì¼ë¡œ ì‹œì‘í•˜ê¸°</div>

            <div class="email-login-section">
                <form id="emailLoginForm" class="email-form">
                    <input
                        type="email"
                        id="emailInput"
                        placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                        required
                    />
                    <button type="submit" class="email-btn"
                        >ì´ë©”ì¼ë¡œ ì‹œì‘í•˜ê¸° (ë§¤ì§ë§í¬)</button
                    >
                </form>
                <div class="helper-text">
                    <p>ì…ë ¥í•œ ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ê°€ ì „ì†¡ë©ë‹ˆë‹¤.</p>
                    <p style="margin-top:0.5rem; color:#4b5563;">
                        ğŸ’¡ <strong>ë¡œê·¸ì¸ ì•ˆë‚´:</strong> ìµœì´ˆ 1íšŒë§Œ ë¡œê·¸ì¸í•˜ì‹œë©´,
                        ì´í›„ì—ëŠ” ë³„ë„ ì ˆì°¨ ì—†ì´ <strong
                            >ìë™ìœ¼ë¡œ ë¡œê·¸ì¸ ìƒíƒœê°€ ìœ ì§€</strong
                        >ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <div class="divider">ê°œë°œìš© ê¸°ëŠ¥</div>

            <div class="test-login">
                <div style="margin-bottom:0.5rem;">[ê°œë°œì ëª¨ë“œ]</div>
                <button id="mockLoginBtn">ìŠ¹ì¸ ëŒ€ê¸° ê³„ì • í…ŒìŠ¤íŠ¸</button>
                <button
                    id="mockLoginApprovedBtn"
                    style="background:#059669; color:white; border:none; padding:0.5rem 1rem; border-radius:4px; cursor:pointer; margin-left:5px;"
                    >ìŠ¹ì¸ ì™„ë£Œ ê³„ì • í…ŒìŠ¤íŠ¸</button
                >
            </div>
        </div>
    </div>

    <script>
        import { userProfile, setUser } from "../store/user";
        import { supabase } from "../lib/supabase";

        // Mock Login Logic
        const mockLogin = (isApproved) => {
            const user = {
                id: "mock-user-123",
                email: isApproved
                    ? "admin@radsafety.com"
                    : "newuser@example.com",
                full_name: isApproved ? "ê¹€ê´€ë¦¬" : "í™ê¸¸ë™",
                avatar_url: "",
                provider: "google",
            };
            setUser(user);

            alert(
                "ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. (Mock Role: " +
                    (isApproved ? "Admin" : "User") +
                    ")",
            );
            window.location.href = "/mypage";
        };

        document
            .getElementById("mockLoginBtn")
            ?.addEventListener("click", () => mockLogin(false));
        document
            .getElementById("mockLoginApprovedBtn")
            ?.addEventListener("click", () => mockLogin(true));

        // Email Login Logic (Magic Link)
        const emailForm = document.getElementById("emailLoginForm");
        emailForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("emailInput").value;
            const btn = emailForm.querySelector("button");

            btn.disabled = true;
            btn.textContent = "ì „ì†¡ ì¤‘...";

            try {
                const { error } = await supabase.auth.signInWithOtp({
                    email: email,
                    options: {
                        emailRedirectTo: `${window.location.origin}/mypage`,
                    },
                });

                if (error) throw error;
                alert(
                    "ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ ë§í¬ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!\në©”ì¼í•¨ì„ í™•ì¸í•´ì£¼ì„¸ìš”.",
                );
            } catch (err) {
                alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = "ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ (ë§¤ì§ë§í¬)";
            }
        });

        // Real Logic
        const btns = document.querySelectorAll(".login-btn");
        btns.forEach((btn) => {
            btn.addEventListener("click", async () => {
                const provider = btn.dataset.provider;
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: provider,
                    options: {
                        redirectTo: `${window.location.origin}/auth/callback`,
                        // Force override scope using queryParams (Supabase sometimes ignores 'scopes' prop)
                        queryParams: {
                            scope: "account_email,profile_nickname", // Request Email explicitly!
                        },
                    },
                });
                if (error) alert("ë¡œê·¸ì¸ ì˜¤ë¥˜: " + error.message);
            });
        });

        // Mock Logic (Optional: Keep for admin testing if needed, or hide)
        document.querySelector(".test-login").style.display = "none";
    </script>
</DashboardLayout>
