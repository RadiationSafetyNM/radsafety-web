---
import BaseHead from "../../components/BaseHead.astro";
---

<!doctype html>
<html lang="ko">
    <head>
        <BaseHead title="로그인 처리 중..." />
        <style>
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                background: #f9fafb;
                flex-direction: column;
                gap: 1rem;
            }
            .loader {
                font-size: 1.1rem;
                font-weight: 600;
                color: #4b5563;
            }
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #e5e7eb;
                border-top: 4px solid #2563eb;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="spinner"></div>
        <div class="loader">로그인 정보를 확인 중입니다...</div>
        <div
            id="status-msg"
            style="margin-top: 1rem; color: #6b7280; font-size: 0.9rem; text-align: center; padding: 0 2rem;"
        >
        </div>
        <a
            id="home-link"
            href="/"
            style="display: none; margin-top: 2rem; padding: 0.75rem 1.5rem; background: #2563eb; color: white; border-radius: 8px; text-decoration: none; font-weight: 600;"
            >홈으로 돌아가기</a
        >

        <script>
            import { supabase } from "../../lib/supabase";

            const statusMsg = document.getElementById("status-msg");
            const homeLink = document.getElementById("home-link");

            const updateStatus = (msg, showButton = false) => {
                if (statusMsg) statusMsg.textContent = msg;
                if (showButton && homeLink) homeLink.style.display = "block";
            };

            // Handle the OAuth callback
            (async () => {
                console.log("Processing Auth Callback...");
                updateStatus("세션을 확인하고 있습니다...");

                try {
                    // 1. Check current session
                    const {
                        data: { session },
                        error,
                    } = await supabase.auth.getSession();

                    if (error) throw error;

                    if (session) {
                        console.log("Session verified! Redirecting...");
                        updateStatus("로그인 성공! 이동 중입니다...");
                        setTimeout(() => {
                            window.location.href = "/mypage";
                        }, 800);
                        return;
                    }

                    // 2. If no session, it might be an in-app browser or PKCE delay
                    updateStatus("로그인 완료를 기다리는 중...");

                    const {
                        data: { subscription },
                    } = supabase.auth.onAuthStateChange((event, session) => {
                        console.log("Auth Event:", event);
                        if (event === "SIGNED_IN" && session) {
                            updateStatus("로그인 성공! 이동 중입니다...");
                            setTimeout(() => {
                                window.location.href = "/mypage";
                            }, 800);
                            subscription.unsubscribe();
                        }
                    });

                    // Timeout fallback
                    setTimeout(() => {
                        updateStatus(
                            "자동 이동이 되지 않으면 아래 버튼을 눌러주세요.",
                            true,
                        );
                    }, 5000);
                } catch (err) {
                    console.error("Auth Error:", err);
                    updateStatus(
                        "로그인 처리 중 오류가 발생했습니다: " + err.message,
                        true,
                    );
                }
            })();
        </script>
    </body>
</html>
