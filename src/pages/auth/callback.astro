---
import BaseHead from "../../components/BaseHead.astro";
---

<!doctype html>
<html lang="ko">
    <head>
        <BaseHead title="로그인 처리 중..." />
        <style>
            body {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
                background: #f9fafb;
                flex-direction: column;
                gap: 1rem;
            }
            .loader {
                font-size: 1.1rem;
                font-weight: 600;
                color: #4b5563;
            }
            .spinner {
                width: 40px;
                height: 40px;
                border: 4px solid #e5e7eb;
                border-top: 4px solid #2563eb;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <div class="spinner"></div>
        <div class="loader">로그인 정보를 안전하게 받아오는 중입니다...</div>
        <script>
            import { supabase } from "../../lib/supabase";

            // Handle the OAuth callback
            (async () => {
                console.log("Processing Auth Callback...");

                // 1. Immediately check if session exists (handled by supabase-js)
                const { data, error } = await supabase.auth.getSession();

                if (error) {
                    console.error("Auth Error:", error);
                    alert("로그인 처리에 실패했습니다. 다시 시도해 주세요.");
                    window.location.href = "/login";
                    return;
                }

                if (data?.session) {
                    console.log("Session verified! Redirecting to MyPage...");
                    // Short delay to ensure local storage write? Usually unnecessary but safer
                    setTimeout(() => {
                        window.location.href = "/mypage";
                    }, 500);
                } else {
                    // 2. If no session yet (PKCE code exchange might be in progress), wait for event
                    console.log("Waiting for auth state change...");
                    const { data: authListener } =
                        supabase.auth.onAuthStateChange((event, session) => {
                            if (event === "SIGNED_IN" && session) {
                                console.log("Signed In Event Received!");
                                setTimeout(() => {
                                    window.location.href = "/mypage";
                                }, 500);
                            }
                        });
                }
            })();
        </script>
    </body>
</html>
