---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import Icon from "../../components/Icon.astro";
---

<DashboardLayout title="íšŒì› ì¼ê´„ ë“±ë¡">
    <div class="admin-container">
        <div class="header">
            <h1><Icon name="users" size="32" /> íšŒì› ë“±ë¡ (Excel)</h1>
            <p class="subtitle">
                ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ íšŒì›ì„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            </p>
        </div>

        <!-- Society Selection -->
        <div class="society-selector">
            <label class="radio-label">
                <input
                    type="radio"
                    name="society"
                    value="nuclear_medicine"
                    checked
                />
                <span>ëŒ€í•œí•µì˜í•™íšŒ</span>
            </label>
            <label class="radio-label">
                <input type="radio" name="society" value="technology" />
                <span>ëŒ€í•œí•µì˜í•™ê¸°ìˆ í•™íšŒ</span>
            </label>
        </div>

        <!-- Drop Zone -->
        <div id="dropZone" class="drop-zone">
            <Icon name="upload" size="48" class="upload-icon" />
            <p class="drop-text">
                ì—‘ì…€ íŒŒì¼(.xlsx, .xls)ì„ ì´ê³³ì— ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”.
            </p>
            <input type="file" id="fileInput" accept=".xlsx, .xls" hidden />
        </div>

        <!-- Preview Table -->
        <div id="previewSection" class="preview-section" style="display: none;">
            <div class="preview-header">
                <h3>ë¯¸ë¦¬ë³´ê¸° (<span id="rowCount">0</span>ëª…)</h3>
                <div class="actions">
                    <button id="cancelBtn" class="btn-secondary">ì·¨ì†Œ</button>
                    <button id="uploadBtn" class="btn-primary"
                        >DBì— ì €ì¥í•˜ê¸°</button
                    >
                </div>
            </div>
            <div class="table-wrapper">
                <table id="previewTable">
                    <thead>
                        <th>ì´ë¦„</th>
                        <th>ê·¼ë¬´ê¸°ê´€ëª…</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì†Œì†í•™íšŒ</th>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <div style="margin-top:1rem; text-align:right;">
            <button
                id="resetBtn"
                style="background:none; border:1px solid #ff4444; color:#ff4444; padding:0.5rem 1rem; border-radius:6px; cursor:pointer; font-size:0.9rem;"
            >
                âš ï¸ ëª…ë‹¨ ì „ì²´ ì´ˆê¸°í™”
            </button>
        </div>
        <!-- Current DB Members Section -->
        <div
            class="db-section"
            style="margin-top: 3rem; border-top: 1px solid var(--border-color); padding-top: 2rem;"
        >
            <h2>í˜„ì¬ DB ë“±ë¡ëœ íšŒì› (<span id="dbCount">0</span>ëª…)</h2>
            <div
                style="display:flex; justify-content:space-between; margin-bottom:1rem;"
            >
                <input
                    type="text"
                    id="dbSearch"
                    placeholder="ì´ë¦„ ë˜ëŠ” ì´ë©”ì¼ ê²€ìƒ‰..."
                    style="padding:0.5rem; border:1px solid var(--border-color); border-radius:6px; width:300px;"
                />
                <button id="refreshDbBtn" class="btn-secondary"
                    >ğŸ”„ ìƒˆë¡œê³ ì¹¨</button
                >
            </div>
            <div class="table-wrapper">
                <table id="dbTable">
                    <thead>
                        <th>ì´ë¦„</th>
                        <th>ê·¼ë¬´ê¸°ê´€ëª…</th>
                        <th>ì´ë©”ì¼</th>
                        <th>ì†Œì†í•™íšŒ</th>
                    </thead>
                    <tbody>
                        <tr
                            ><td colspan="4" style="text-align:center;"
                                >ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td
                            ></tr
                        >
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</DashboardLayout>

<!-- Admin Guard Script -->
<script>
    import { userProfile } from "../../store/user";
    import { supabase } from "../../lib/supabase";
    import * as XLSX from "xlsx";

    // ... (Existing Guard Logic) ...
    // ... (Existing Excel Logic) ...

    // --- NEW: DB Member List Logic ---
    const dbTableBody = document.querySelector("#dbTable tbody");
    const dbCountSpan = document.getElementById("dbCount");
    const dbSearchInput = document.getElementById("dbSearch");
    const refreshDbBtn = document.getElementById("refreshDbBtn");

    let allMembers = [];

    async function fetchMembers() {
        refreshDbBtn.disabled = true;
        refreshDbBtn.textContent = "ë¡œë”© ì¤‘...";

        const { data, error } = await supabase
            .from("allowed_members")
            .select("*")
            .order("created_at", { ascending: false });

        if (error) {
            console.error(error);
            alert("DB ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤: " + error.message);
            dbTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
        } else {
            allMembers = data || [];
            renderDbTable(allMembers);
        }

        refreshDbBtn.disabled = false;
        refreshDbBtn.textContent = "ğŸ”„ ìƒˆë¡œê³ ì¹¨";
    }

    function renderDbTable(list) {
        dbCountSpan.textContent = list.length;
        dbTableBody.innerHTML = "";

        if (list.length === 0) {
            dbTableBody.innerHTML = `<tr><td colspan="4" style="text-align:center;">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
            return;
        }

        list.slice(0, 100).forEach((row) => {
            // Limit display for performance
            const tr = document.createElement("tr");
            const societyName =
                row.society === "nuclear_medicine"
                    ? "ëŒ€í•œí•µì˜í•™íšŒ"
                    : row.society === "technology"
                      ? "ëŒ€í•œí•µì˜í•™ê¸°ìˆ í•™íšŒ"
                      : row.society || "-";
            tr.innerHTML = `
                <td>${row.name || "-"}</td>
                <td>${row.affiliation || "-"}</td>
                <td>${row.email || "-"}</td>
                <td>${societyName}</td>
            `;
            dbTableBody.appendChild(tr);
        });

        if (list.length > 100) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td colspan="4" style="text-align:center; color:#888;">...ì™¸ ${list.length - 100}ëª… (ê²€ìƒ‰í•˜ì—¬ í™•ì¸í•˜ì„¸ìš”)</td>`;
            dbTableBody.appendChild(tr);
        }
    }

    // Search Handler
    dbSearchInput.addEventListener("input", (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allMembers.filter(
            (m) =>
                (m.name && m.name.toLowerCase().includes(keyword)) ||
                (m.email && m.email.toLowerCase().includes(keyword)),
        );
        renderDbTable(filtered);
    });

    refreshDbBtn.addEventListener("click", fetchMembers);

    // Initial Load
    fetchMembers();

    // 2. Excel Logic (Keep existing logic below...)

    // 1. Admin Guard
    const user = userProfile.get();
    if (user.role !== "admin") {
        alert("ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/";
    }

    // 2. Excel Logic
    const dropZone = document.getElementById("dropZone");
    const fileInput = document.getElementById("fileInput");
    const previewSection = document.getElementById("previewSection");
    const tableBody = document.querySelector("#previewTable tbody");
    const rowCountSpan = document.getElementById("rowCount");

    // Drag & Drop Handlers
    dropZone.addEventListener("click", () => fileInput.click());

    dropZone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropZone.classList.add("drag-over");
    });

    dropZone.addEventListener("dragleave", () => {
        dropZone.classList.remove("drag-over");
    });

    dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropZone.classList.remove("drag-over");
        const files = e.dataTransfer.files;
        if (files.length) handleFile(files[0]);
    });

    fileInput.addEventListener("change", (e) => {
        if (e.target.files.length) handleFile(e.target.files[0]);
    });

    function handleFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: "array" });

                // Read first sheet
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];

                // Convert to JSON
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                renderTable(jsonData);
            } catch (err) {
                console.error("Excel Read Error:", err);
                alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n" + err.message);
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function findValue(row, possibleKeys) {
        const rowKeys = Object.keys(row);
        // 1. Exact match attempt
        for (const key of possibleKeys) {
            if (row[key] !== undefined) return row[key];
        }

        // 2. Fuzzy match (ignore whitespace, case, special chars)
        const normalizedKeys = rowKeys.reduce((acc, k) => {
            const norm = k
                .toString()
                .toLowerCase()
                .replace(/[\s\-_.]/g, "");
            acc[norm] = k;
            return acc;
        }, {});

        for (const key of possibleKeys) {
            const normSearch = key.toLowerCase().replace(/[\s\-_.]/g, "");
            if (normalizedKeys[normSearch]) {
                return row[normalizedKeys[normSearch]];
            }

            // 3. Partial inclusion check (e.g. 'User Email' matches 'email')
            const partialMatch = Object.keys(normalizedKeys).find((nk) =>
                nk.includes(normSearch),
            );
            if (partialMatch) return row[normalizedKeys[partialMatch]];
        }
        return null;
    }

    function renderTable(data) {
        console.log("Raw Excel Data:", data); // Debug log

        // Get default society selection
        const selectedSociety = document.querySelector(
            'input[name="society"]:checked',
        ).value;

        const processedData = data.map((row) => {
            const name = (
                findValue(row, [
                    "ì´ë¦„",
                    "name",
                    "ì„±ëª…",
                    "membername",
                    "user",
                ]) || "-"
            )
                .toString()
                .trim();
            const email = (
                findValue(row, [
                    "ì´ë©”ì¼",
                    "email",
                    "e-mail",
                    "mail",
                    "ì „ììš°í¸",
                    "ê³„ì •",
                ]) || "-"
            )
                .toString()
                .trim();
            const affiliation = (
                findValue(row, [
                    "ê·¼ë¬´ê¸°ê´€ëª…",
                    "ê·¼ë¬´ê¸°ê´€",
                    "ì†Œì†",
                    "affiliation",
                    "organization",
                    "org",
                    "company",
                    "institution",
                    "hospital",
                    "workplace",
                ]) || "-"
            )
                .toString()
                .trim();

            // Society Parsing Logic
            let societyRaw =
                findValue(row, [
                    "ì†Œì†í•™íšŒ",
                    "êµ¬ë¶„",
                    "division",
                    "society",
                    "í•™íšŒ",
                    "type",
                ]) || "";
            let society = selectedSociety; // Default to selection

            if (societyRaw) {
                const normalizedParams = societyRaw
                    .toString()
                    .trim()
                    .replace(/[\s|_]/g, "");
                if (
                    [
                        "ëŒ€í•œí•µì˜í•™íšŒ",
                        "í•µì˜í•™íšŒ",
                        "nuclear_medicine",
                        "ì˜ì‚¬",
                        "prof",
                    ].some((k) => normalizedParams.includes(k))
                ) {
                    society = "nuclear_medicine";
                } else if (
                    [
                        "ëŒ€í•œí•µì˜í•™ê¸°ìˆ í•™íšŒ",
                        "í•µì˜í•™ê¸°ìˆ í•™íšŒ",
                        "ê¸°ìˆ í•™íšŒ",
                        "technology",
                        "tech",
                    ].some((k) => normalizedParams.includes(k))
                ) {
                    society = "technology";
                }
            }
            // If raw exists but didn't match known keys, we keep default (or could fallback to raw if we trusted it, but safer to enforce schema)

            const societyDisplay =
                society === "nuclear_medicine"
                    ? "ëŒ€í•œí•µì˜í•™íšŒ"
                    : "ëŒ€í•œí•µì˜í•™ê¸°ìˆ í•™íšŒ";

            return { name, email, affiliation, society, societyDisplay };
        });

        // Store normalized data for consistent upload
        window.parsedMemberData = processedData;

        tableBody.innerHTML = "";

        processedData.forEach((row) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                    <td>${row.name}</td>
                    <td>${row.affiliation}</td>
                    <td>${row.email}</td>
                    <td>${row.societyDisplay}</td>
                `;
            tableBody.appendChild(tr);
        });

        rowCountSpan.textContent = data.length;
        previewSection.style.display = "block";
        dropZone.style.display = "none";
        // Hide society selector during preview to avoid confusion? Or keep it?
        // Let's keep it but maybe disable it implies it was only for initial defaults.
        // For now, simple is best.
    }

    // Cancel
    document.getElementById("cancelBtn").addEventListener("click", () => {
        previewSection.style.display = "none";
        dropZone.style.display = "flex";
        fileInput.value = "";
        tableBody.innerHTML = "";
    });

    // Reset DB
    const resetBtn = document.getElementById("resetBtn");
    if (resetBtn) {
        resetBtn.addEventListener("click", async () => {
            if (
                confirm(
                    "ì •ë§ë¡œ ëª¨ë“  ëª…ë‹¨ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
                )
            ) {
                const { error } = await supabase
                    .from("allowed_members")
                    .delete()
                    .neq("id", 0);
                if (error) {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + error.message);
                } else {
                    alert("ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    window.location.reload();
                }
            }
        });
    }

    // Upload (Real)
    document.getElementById("uploadBtn").addEventListener("click", async () => {
        if (!window.parsedMemberData || window.parsedMemberData.length === 0) {
            alert("ë“±ë¡í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const dataToUpload = window.parsedMemberData
            .map((row) => ({
                name: row.name !== "-" ? row.name : null,
                email: row.email !== "-" ? row.email : null,
                affiliation: row.affiliation !== "-" ? row.affiliation : null,
                society: row.society, // Send the determined society code
                // Schema update required: Ensure 'society' column exists in allowed_members table
            }))
            .filter((r) => r.email && r.email.includes("@"));

        if (dataToUpload.length === 0) {
            alert("ìœ íš¨í•œ ì´ë©”ì¼ì´ í¬í•¨ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // Deduplicate Logic: Keep the last occurrence for each email
        const uniqueData = Array.from(
            dataToUpload
                .reduce((map, item) => map.set(item.email, item), new Map())
                .values(),
        );

        const confirmUpload = confirm(
            `${uniqueData.length}ëª…ì˜ íšŒì›ì„ DBì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì¤‘ë³µëœ ì´ë©”ì¼ì€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤)`,
        );

        if (confirmUpload) {
            const { data, error } = await supabase
                .from("allowed_members")
                .upsert(uniqueData, { onConflict: "email" });

            if (error) {
                console.error(error);
                alert("ì—…ë¡œë“œ ì‹¤íŒ¨:\n" + error.message);
            } else {
                alert("âœ… ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                window.location.reload();
            }
        }
    });
</script>

<style>
    .admin-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem 0;
    }
    .header {
        margin-bottom: 2rem;
    }
    .subtitle {
        color: var(--text-muted);
    }

    .society-selector {
        display: flex;
        justify-content: center;
        gap: 2rem;
        margin-bottom: 1.5rem;
        background: var(--bg-card);
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }
    .radio-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: 500;
    }
    .radio-label input[type="radio"] {
        width: 1.2rem;
        height: 1.2rem;
        accent-color: var(--accent);
    }

    .drop-zone {
        border: 3px dashed var(--border-color);
        border-radius: 12px;
        padding: 4rem 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        background: var(--bg-card);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    .drop-zone:hover,
    .drop-zone.drag-over {
        border-color: var(--accent);
        background: rgba(37, 99, 235, 0.05); /* Slight accent tint */
    }
    .upload-icon {
        color: var(--text-muted);
    }
    .drop-text {
        color: var(--text-muted);
        font-size: 1.1rem;
    }

    .preview-section {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
    }
    .preview-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    .actions {
        display: flex;
        gap: 0.5rem;
    }

    .btn-primary {
        background: var(--accent);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-weight: bold;
    }
    .btn-secondary {
        background: transparent;
        color: var(--text-main);
        border: 1px solid var(--border-color);
        padding: 0.5rem 1rem;
        border-radius: 6px;
    }

    .table-wrapper {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 6px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.95rem;
    }
    th,
    td {
        padding: 0.75rem 1rem;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
    }
    th {
        background: rgba(255, 255, 255, 0.05);
        position: sticky;
        top: 0;
        color: var(--text-muted);
    }
</style>
