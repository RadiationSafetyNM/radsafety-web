---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import Icon from "../components/Icon.astro";

// Mock Data for Resources (Eventually from Supabase or Content Collection)
// Mock Data for Resources (Eventually from Supabase or Content Collection)
const resources = [
    {
        id: 103,
        title: "질병관리청 방사선안전관리규정(제161호)",
        version: "2025.03.19",
        category: "가이드북",
        date: "2025-03-19",
        author: "질병관리청",
        authority: "KDCA",
        description:
            "질병관리청 예규 제161호에 따른 방사선안전관리규정 표준안입니다.",
        tags: ["#질병관리청", "#안전관리규정", "#표준안"],
        fileSize: "PDF",
        isNew: true,
        previewUrl:
            "/archive/질병관리청 방사선안전관리규정(질병관리청예규)(제161호)(20250319).pdf",
        downloadUrl:
            "/archive/질병관리청 방사선안전관리규정(질병관리청예규)(제161호)(20250319).pdf",
        type: "pdf",
    },
    {
        id: 1,
        title: "방사선분야 정기검사 수검가이드",
        version: "2022년 개정 최종본",
        category: "가이드북",
        date: "2022-12-01",
        author: "한국원자력안전기술원(KINS)",
        authority: "KINS",
        description:
            "방사선안전관리 정기검사 수검을 위한 공식 가이드라인입니다. 주요 점검 항목과 절차를 안내합니다.",
        tags: ["#정기검사", "#KINS", "#가이드"],
        fileSize: "PDF",
        isNew: false,
        previewUrl:
            "/archive/방사선분야 정기검사수검가이드(2022년 개정)_최종본.pdf",
        downloadUrl:
            "/archive/방사선분야 정기검사수검가이드(2022년 개정)_최종본.pdf",
        type: "pdf",
    },
    {
        id: 101,
        title: "안전관리규정 작성지침",
        version: "2024.12.31 고시 반영",
        category: "가이드북",
        date: "2024-12-31",
        author: "원자력안전위원회",
        authority: "NSSC",
        description:
            "원자력안전법 시행규칙 및 관련 고시에 따른 안전관리규정 작성 기준 및 필수 포함 사항을 기술한 지침입니다.",
        tags: ["#안전관리규정", "#규정작성", "#인허가"],
        fileSize: "PDF",
        isNew: true,
        previewUrl: "/archive/안전관리규정_작성지침.pdf",
        downloadUrl: "/archive/안전관리규정_작성지침.pdf",
        type: "pdf",
    },
    {
        id: 102,
        title: "안전관리규정 예시 (의료기관)",
        version: "v1.0",
        category: "서식",
        date: "2024-01-01",
        author: "KINS",
        authority: "KINS",
        description:
            "의료기관을 위한 안전관리규정 작성 예시입니다. 병원 특성에 맞게 내용을 수정하여 사용하십시오.",
        tags: ["#의료기관", "#규정예시", "#서식"],
        fileSize: "PDF",
        isNew: false,
        previewUrl: "/archive/안전관리규정_예시.pdf",
        downloadUrl: "/archive/안전관리규정_예시.pdf", // Assuming source is same or similar for now
        type: "pdf",
    },
    {
        id: 3,
        title: "방사선작업종사자 교육일지 양식",
        version: "표준양식",
        category: "서식",
        date: "2023-12-20",
        author: "관리자",
        authority: "Society",
        description:
            "법정 의무 교육 이수 내용을 기록하기 위한 표준 양식입니다. (미리보기는 PDF, 다운로드는 HWP)",
        tags: ["#교육", "#일지", "#HWP"],
        fileSize: "45KB",
        isNew: false,
        previewUrl: "#", // Needs PDF version
        downloadUrl: "#", // Needs HWP version
        type: "file",
        fileType: "HWP",
    },
    {
        id: 5,
        title: "원자력안전법 주요 개정사항 요약",
        version: "2023 하반기",
        category: "법령정보",
        date: "2023-10-10",
        author: "관리자",
        authority: "Society",
        description:
            "2023년 하반기에 개정된 원자력안전법의 주요 내용을 요약하였습니다.",
        tags: ["#법령", "#개정사항", "#요약"],
        fileSize: "1.1MB",
        isNew: false,
        previewUrl: "#",
        downloadUrl: "#",
        type: "file",
        fileType: "PDF",
    },
];

const categories = ["전체", "가이드북", "서식", "법령정보", "안내문"];
---

<DashboardLayout title="자료실">
    <style>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 0.5rem;
            position: relative;
            width: 100%;
            max-width: 500px;
            display: flex;
            gap: 0.5rem;
        }
        #resourceSearch {
            width: 100%;
            box-sizing: border-box;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 99px;
            box-shadow: 0 1px 2px var(--shadow-color);
            color: var(--text-main);
            transition: border-color 0.2s;
        }
        #resourceSearch:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            display: flex;
        }

        /* List Styles - Compact Modern */
        .resource-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* Tighter gap */
        }
        .resource-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Slightly smaller radius */
            padding: 0.75rem 1rem; /* Compact padding */
            display: flex;
            align-items: center; /* Center vertically */
            justify-content: space-between;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03); /* Very subtle shadow */
        }
        .resource-card:hover {
            background: var(
                --bg-hover
            ); /* Highlight on hover instead of lift */
            border-color: var(--accent);
        }

        .card-left {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            overflow: hidden; /* Prevent text spill */
        }

        .resource-info {
            display: flex;
            flex-direction: column;
            gap: 0.1rem;
            overflow: hidden;
        }

        .info-top {
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .resource-title {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .new-dot {
            width: 6px;
            height: 6px;
            background-color: #ef4444;
            border-radius: 50%;
            display: inline-block;
        }

        .info-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .meta-item {
            display: inline-block;
        }
        .meta-item.category {
            font-weight: 600;
            color: var(--text-main);
        }
        .meta-divider {
            color: var(--border-color);
            font-size: 0.7rem;
        }

        .version-badge {
            background: var(--bg-body);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0 0.3rem;
            font-size: 0.7rem;
        }

        .download-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            cursor: pointer;
            padding: 0.4rem;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .download-btn:hover {
            background: var(--bg-body);
            color: var(--accent);
            border-color: var(--accent);
        }

        @media (max-width: 640px) {
            .resource-list {
                gap: 0.35rem;
            }
            .resource-card {
                padding: 0.6rem 0.8rem;
                gap: 0.8rem;
            }
            /* Keep row layout on mobile! */
            .resource-title {
                font-size: 0.9rem;
            }
            .info-meta {
                font-size: 0.75rem;
            }
            /* Hide less important meta on small screens */
            .meta-item:nth-child(n + 4),
            .meta-divider:nth-child(n + 4) {
                display: none;
            }
            /* Sort Header */
            .sort-header {
                display: flex;
                gap: 1rem;
                margin-bottom: 1rem;
                padding: 0 0.5rem;
            }
            .sort-btn {
                background: none;
                border: none;
                font-size: 0.85rem;
                color: var(--text-muted);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.25rem;
                padding: 0.2rem 0;
            }
            .sort-btn:hover {
                color: var(--text-main);
            }
            .sort-btn.active {
                color: var(--accent);
                font-weight: 600;
            }
            .sort-icon {
                transition: transform 0.2s;
                opacity: 0;
            }
            .sort-btn.active .sort-icon {
                opacity: 1;
            }
            .sort-btn.asc .sort-icon {
                transform: rotate(180deg);
            }
        }
    </style>

    <style>
        /* Sort Header - Global/Desktop */
        .sort-header {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 0 0.5rem;
            align-items: center;
        }
        .sort-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.2rem 0;
            transition: color 0.2s;
        }
        .sort-btn:hover {
            color: var(--text-main);
        }
        .sort-btn.active {
            color: var(--accent);
            font-weight: 600;
        }
        .sort-icon {
            transition: transform 0.2s;
            opacity: 0;
            display: inline-block; /* Ensure transform works */
            transform-origin: center; /* Rotate around center */
        }
        .sort-btn.active .sort-icon {
            opacity: 1;
        }
        .sort-btn.asc .sort-icon {
            transform: rotate(180deg);
        }
    </style>

    <div class="page-header">
        <div class="page-title">
            <Icon name="document-text" size="28" /> 자료실
        </div>
        <!-- Maybe Admin Upload Button later -->
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <input
            type="text"
            id="resourceSearch"
            placeholder="자료 검색 (예: 가이드, 서식, 2024)"
            aria-label="자료 검색"
        />
        <span class="search-icon"><Icon name="search" size="18" /></span>
    </div>

    <div
        id="noResults"
        style="display: none; text-align: center; padding: 2rem; color: var(--text-muted);"
    >
        검색 결과가 없습니다.
    </div>

    <!-- Sort Header -->
    <div class="sort-header">
        <button class="sort-btn active" data-sort="date" data-order="desc">
            날짜 <Icon name="chevron-down" size="14" class="sort-icon" />
        </button>
        <button class="sort-btn" data-sort="title" data-order="none">
            제목 <Icon name="chevron-down" size="14" class="sort-icon" />
        </button>
        <button class="sort-btn" data-sort="author" data-order="none">
            작성자 <Icon name="chevron-down" size="14" class="sort-icon" />
        </button>
        <button class="sort-btn" data-sort="category" data-order="none">
            태그(분류) <Icon name="chevron-down" size="14" class="sort-icon" />
        </button>
    </div>

    <div class="resource-list" id="resourceList">
        {
            resources
                .sort(
                    (a, b) =>
                        new Date(b.date).getTime() - new Date(a.date).getTime(),
                )
                .map((item) => (
                    <div
                        class="resource-card"
                        data-title={item.title}
                        data-date={item.date}
                        data-author={item.author}
                        data-category={item.category}
                        onclick={`if(event.target.closest('.download-btn')) return; 
                            ${
                                item.previewUrl && item.previewUrl !== "#"
                                    ? `window.open('${item.previewUrl}', '_blank')`
                                    : `alert('미리보기가 준비되지 않았습니다.\\n오른쪽 다운로드 버튼을 이용해 주세요.');`
                            }`}
                    >
                        <div class="card-left">
                            <div class="resource-info">
                                <div class="info-top">
                                    <span class="resource-title">
                                        {item.title}
                                    </span>
                                    {item.isNew && <span class="new-dot" />}
                                </div>

                                <div class="info-meta">
                                    <span class="meta-item category">
                                        {item.category}
                                    </span>
                                    <span class="meta-divider">|</span>
                                    <span class="meta-item">{item.author}</span>
                                    <span class="meta-divider">|</span>
                                    <span class="meta-item">{item.date}</span>
                                    {item.version && (
                                        <span class="version-badge">
                                            {item.version}
                                        </span>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div class="card-right">
                            <a
                                href={item.downloadUrl}
                                class="download-btn"
                                download={item.downloadUrl !== "#"}
                                target={
                                    item.downloadUrl !== "#"
                                        ? "_blank"
                                        : "_self"
                                }
                                onclick={
                                    item.downloadUrl === "#"
                                        ? "event.preventDefault(); event.stopPropagation(); alert('다운로드 파일이 준비되지 않았습니다.');"
                                        : "event.stopPropagation();"
                                }
                                aria-label="Download"
                            >
                                <Icon name="download" size="20" />
                            </a>
                        </div>
                    </div>
                ))
        }
    </div>

    <script>
        document.addEventListener("astro:page-load", () => {
            initResources();
        });

        if (document.readyState !== "loading") {
            initResources();
        }

        function initResources() {
            const searchInput = document.getElementById("resourceSearch");
            const sortBtns = document.querySelectorAll(".sort-btn");
            const resourceList = document.getElementById("resourceList");
            const noResults = document.getElementById("noResults");

            let currentSearch = "";

            function filterItems() {
                const cards = Array.from(resourceList.children);
                let hasVisible = false;

                cards.forEach((card) => {
                    const title =
                        card.getAttribute("data-title")?.toLowerCase() || "";
                    const category = card.getAttribute("data-category") || "";

                    // Simple search filtering (includes category name in search)
                    const matchSearch =
                        title.includes(currentSearch) ||
                        category.toLowerCase().includes(currentSearch);

                    if (matchSearch) {
                        card.style.display = "flex";
                        hasVisible = true;
                    } else {
                        card.style.display = "none";
                    }
                });

                if (noResults) {
                    noResults.style.display = hasVisible ? "none" : "block";
                }
            }

            function sortItems(key, order) {
                const visibleCards = Array.from(resourceList.children);

                // If order is 'none' or null, revert to default (Date Descending)
                if (!order || order === "none") {
                    visibleCards.sort((a, b) => {
                        const dateA = a.getAttribute("data-date") || "";
                        const dateB = b.getAttribute("data-date") || "";
                        return (
                            new Date(dateB).getTime() -
                            new Date(dateA).getTime()
                        );
                    });
                } else {
                    visibleCards.sort((a, b) => {
                        let valA = a.getAttribute(`data-${key}`) || "";
                        let valB = b.getAttribute(`data-${key}`) || "";

                        if (key === "date") {
                            return order === "asc"
                                ? new Date(valA).getTime() -
                                      new Date(valB).getTime()
                                : new Date(valB).getTime() -
                                      new Date(valA).getTime();
                        }

                        return order === "asc"
                            ? valA.localeCompare(valB)
                            : valB.localeCompare(valA);
                    });
                }

                visibleCards.forEach((card) => resourceList.appendChild(card));
            }

            // Search Logic
            if (searchInput) {
                searchInput.addEventListener("input", (e) => {
                    currentSearch = e.target.value.toLowerCase().trim();
                    filterItems();
                });
            }

            // Sort Logic (3-State: Desc -> Asc -> None)
            sortBtns.forEach((btn) => {
                btn.addEventListener("click", () => {
                    const key = btn.getAttribute("data-sort");
                    const currentOrder = btn.getAttribute("data-order"); // 'desc', 'asc', or null/'none'

                    // Cycle: Desc -> Asc -> None -> Desc ...
                    // If currently 'desc' -> go 'asc'
                    // If currently 'asc' -> go 'none'
                    // If currently 'none' (or other) -> go 'desc'

                    let newOrder = "desc";
                    if (currentOrder === "desc") {
                        newOrder = "asc";
                    } else if (currentOrder === "asc") {
                        newOrder = "none";
                    } else {
                        newOrder = "desc";
                    }

                    // Reset all buttons first
                    sortBtns.forEach((b) => {
                        b.classList.remove("active", "asc", "desc");
                        b.setAttribute("data-order", "none");
                    });

                    // Update current button if not 'none'
                    if (newOrder !== "none") {
                        btn.classList.add("active", newOrder);
                        btn.setAttribute("data-order", newOrder);
                        console.log(`Sort updated: ${key} -> ${newOrder}`); // Debug Log
                    } else {
                        // If 'none', no button is active (or maybe Date default?
                        // UX Choice: Visual reset implies "Default".
                        // Let's keep Date button active if it matches default?
                        // For simplicity/clarity, 'none' means no *explicit* sort highlight, just default list.
                        // But user might want to know it's back to default.
                        // Let's just remove highlight for true 'none'.
                    }

                    sortItems(key, newOrder);
                });
            });
        }
    </script>
</DashboardLayout>
