---
import DashboardLayout from "../layouts/DashboardLayout.astro";
import Icon from "../components/Icon.astro";
import { supabase } from "../lib/supabase";

const categories = [
    "ì‘ì„±ì§€ì¹¨",
    "ì‘ì„±ì˜ˆì‹œ",
    "ì„œì‹",
    "êµìœ¡ìë£Œ",
    "ë²•ë ¹ì •ë³´",
    "ì•ˆë‚´ë¬¸",
    "ì•„ì¹´ì´ë¸Œ",
    "ê¸°íƒ€",
];
---

<DashboardLayout title="ìë£Œì‹¤">
    <!-- Toast UI Editor CDN -->
    <link
        rel="stylesheet"
        href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css"
    />
    <link
        rel="stylesheet"
        href="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.css"
    />

    <style is:global>
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .page-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Search Bar */
        .search-container {
            margin-bottom: 2rem;
            position: relative;
            width: 100%;
            max-width: 500px;
            display: flex;
            gap: 0.5rem;
        }
        #resourceSearch {
            width: 100%;
            box-sizing: border-box;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            font-size: 0.95rem;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 99px;
            box-shadow: 0 1px 2px var(--shadow-color);
            color: var(--text-main);
            transition: border-color 0.2s;
        }
        #resourceSearch:focus {
            outline: none;
            border-color: var(--accent);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            display: flex;
        }

        /* Sort & Filter Header */
        .controls-header {
            display: grid;
            grid-template-columns: 120px 1fr 120px 120px 30px;
            gap: 1rem;
            padding: 0.5rem 1rem 0.5rem 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 1rem;
            align-items: center;
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .cat-filter-dropdown {
            position: relative;
            overflow: visible;
            z-index: 101;
        }
        .cat-filter-btn {
            list-style: none;
            width: 100%;
            padding: 0.4rem 0.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            text-align: left;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        .cat-filter-btn::-webkit-details-marker {
            display: none;
        }
        .cat-filter-content {
            position: absolute;
            top: 100%;
            left: 0;
            width: 200px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            padding: 0.5rem;
            margin-top: 5px;
            z-index: 200;
        }
        .cat-filter-item {
            display: block;
            width: 100%;
            text-align: left;
            padding: 0.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-main);
            font-size: 0.9rem;
            border-radius: 4px;
        }
        .cat-filter-item:hover {
            background: var(--bg-hover);
        }

        .sort-btn {
            background: none;
            border: none;
            font-size: 0.9rem;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0;
            font-weight: 600;
        }
        .sort-btn.active {
            color: var(--accent);
        }
        .sort-icon {
            display: inline-block;
            opacity: 0;
            transition: transform 0.2s;
        }
        .sort-btn.active .sort-icon {
            opacity: 1;
        }
        .sort-btn.active.asc .sort-icon {
            transform: rotate(180deg);
        }

        /* Resource List */
        .resource-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .resource-card {
            display: grid;
            grid-template-columns: 120px 1fr 120px 120px 30px;
            gap: 1rem;
            align-items: center;
            padding: 0.5rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            color: inherit;
        }
        .resource-card:hover {
            border-color: var(--accent);
            background: var(--bg-hover);
        }

        .cat-badge {
            font-size: 0.75rem;
            background: var(--bg-body);
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            color: var(--text-muted);
            border: 1px solid var(--border-color);
            white-space: nowrap;
        }
        .col-title {
            font-weight: 500;
            color: var(--text-main);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .col-date,
        .col-author {
            font-size: 0.85rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-overlay.active {
            display: flex;
        }
        .modal-content {
            background: var(--bg-card);
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        .form-input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-body);
            color: var(--text-main);
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 2rem;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 500;
        }
        .btn-submit {
            background: var(--accent);
            color: white;
        }
        .btn-cancel {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
        }

        /* Viewer Styles */
        .viewer-content-area {
            min-height: 300px;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            overflow-y: auto;
            max-height: 60vh;
        }
        .pdf-download-bar {
            background: var(--bg-hover);
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .controls-header {
                grid-template-columns: 80px 1fr 70px 30px;
                gap: 0.5rem;
            }
            .controls-header .header-item:nth-child(4) {
                display: none;
            } /* Hide author on mobile header */

            .resource-card {
                grid-template-columns: 80px 1fr 70px 30px;
                gap: 0.5rem;
                padding: 0.75rem 0.5rem;
            }
            .col-author {
                display: none;
            }
            .col-date {
                text-align: right;
                font-size: 0.75rem;
            }
            .cat-badge {
                font-size: 0.7rem;
                padding: 0.1rem 0.3rem;
            }
            .col-title {
                font-size: 0.9rem;
            }
        }
    </style>

    <div class="page-header">
        <div class="page-title">
            <Icon name="folder" size="28" /> ìë£Œì‹¤
        </div>
        <div>
            <button
                id="openModalBtn"
                class="download-btn"
                style="gap: 0.5rem; padding: 0.5rem 1rem; display:none;"
            >
                <Icon name="pencil" size="16" /> ìë£Œ ë“±ë¡
            </button>
        </div>
    </div>

    <!-- Search Bar -->
    <div class="search-container">
        <input
            type="text"
            id="resourceSearch"
            placeholder="ìë£Œ ê²€ìƒ‰ (ì œëª©, ì‘ì„±ì)"
        />
        <span class="search-icon"><Icon name="search" size="18" /></span>
    </div>

    <!-- Controls -->
    <div class="controls-header">
        <div class="header-item">
            <details class="cat-filter-dropdown" id="catFilterDropdown">
                <summary class="cat-filter-btn" id="catFilterBtn">
                    <span>ì „ì²´</span>
                    <Icon name="chevron-down" size="14" />
                </summary>
                <div class="cat-filter-content">
                    <button class="cat-filter-item" data-value="">ì „ì²´</button>
                    {
                        categories.map((cat) => (
                            <button class="cat-filter-item" data-value={cat}>
                                {cat}
                            </button>
                        ))
                    }
                </div>
            </details>
        </div>
        <div class="header-item">
            <button class="sort-btn" data-sort="title" data-order="none"
                >ì œëª© <Icon
                    name="chevron-down"
                    size="14"
                    class="sort-icon"
                /></button
            >
        </div>
        <div class="header-item">
            <button class="sort-btn active" data-sort="date" data-order="desc"
                >ë‚ ì§œ <Icon
                    name="chevron-down"
                    size="14"
                    class="sort-icon"
                /></button
            >
        </div>
        <div class="header-item">
            <button class="sort-btn" data-sort="author" data-order="none"
                >ì‘ì„±ì <Icon
                    name="chevron-down"
                    size="14"
                    class="sort-icon"
                /></button
            >
        </div>
        <div class="header-item"></div>
    </div>

    <!-- List -->
    <div class="resource-list" id="resourceList">
        <p style="text-align:center; padding:2rem;">ë¡œë”© ì¤‘...</p>
    </div>

    <!-- Write/Edit Modal -->
    <div id="writeModal" class="modal-overlay">
        <div class="modal-content">
            <div
                class="modal-header"
                style="font-size:1.2rem; font-weight:bold; margin-bottom:1rem;"
            >
                ìë£Œ ë“±ë¡
            </div>
            <form id="writeForm">
                <input type="hidden" id="editId" />
                <div class="form-group">
                    <label class="form-label">ì œëª©</label>
                    <input
                        type="text"
                        id="writeTitle"
                        class="form-input"
                        required
                        placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                    />
                </div>
                <div class="form-group" style="display:flex; gap:1rem;">
                    <div style="flex:1;">
                        <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                        <select id="writeCategory" class="form-input">
                            {
                                categories.map((c) => (
                                    <option value={c}>{c}</option>
                                ))
                            }
                        </select>
                    </div>
                    <div style="flex:1;">
                        <label class="form-label">ì‘ì„±ì</label>
                        <input
                            type="text"
                            id="writeAuthor"
                            class="form-input"
                            value="ê´€ë¦¬ì"
                        />
                    </div>
                </div>

                <div
                    class="form-group"
                    style="background:var(--bg-body); padding:1rem; border-radius:8px;"
                >
                    <label class="form-label">ì²¨ë¶€ íŒŒì¼ (ëª¨ë“  í˜•ì‹ ê°€ëŠ¥)</label>
                    <input type="file" id="writeFile" />
                    <div
                        id="currentFileDisplay"
                        style="margin-top:0.5rem; font-size:0.85rem; color:var(--text-muted);"
                    >
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ë¶€ê°€ ì„¤ëª… (í•„ìš” ì‹œ)</label>
                    <p
                        style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.5rem;"
                    >
                        ì²¨ë¶€ íŒŒì¼ ì™¸ì— ì¶”ê°€ì ì¸ ì„¤ëª…ì´ í•„ìš”í•œ ê²½ìš° ì…ë ¥í•˜ì„¸ìš”.
                    </p>
                    <div id="editor"></div>
                </div>

                <div class="form-actions">
                    <button
                        type="button"
                        id="closeWriteModal"
                        class="btn btn-cancel">ì·¨ì†Œ</button
                    >
                    <button type="submit" class="btn btn-submit">ì €ì¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Viewer Modal -->
    <div id="viewerModal" class="modal-overlay">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; align-items:start; margin-bottom:1rem;"
            >
                <div>
                    <div
                        class="cat-badge"
                        id="viewCategory"
                        style="display:inline-block; margin-bottom:0.5rem;"
                    >
                    </div>
                    <h2
                        id="viewTitle"
                        style="font-size:1.3rem; margin:0; color: white;"
                    >
                    </h2>
                    <div
                        style="font-size:0.9rem; color:var(--text-muted); margin-top:0.2rem;"
                    >
                        <span id="viewAuthor"></span> Â· <span id="viewDate"
                        ></span>
                    </div>
                </div>
                <button
                    id="closeViewerBtn"
                    style="background:none; border:none; color: white; font-size:1.5rem; cursor:pointer;"
                    >&times;</button
                >
            </div>

            <div
                id="pdfDownloadBar"
                class="pdf-download-bar"
                style="display:none;"
            >
                <div>
                    <strong>íŒŒì¼ì´ ì²¨ë¶€ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</strong>
                    <div style="font-size:0.85rem; opacity:0.8;">
                        ì›ë³¸ì„ í™•ì¸í•˜ì‹œë ¤ë©´ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.
                    </div>
                </div>
                <a
                    id="downloadLink"
                    href="#"
                    target="_blank"
                    class="download-btn"
                    style="text-decoration:none; padding:0.5rem 1rem; background: var(--accent); color: white; border-radius: 6px; font-weight: 600;"
                >
                    <Icon name="download" size="16" /> ë‹¤ìš´ë¡œë“œ / ë³´ê¸°
                </a>
            </div>

            <div id="viewer" class="viewer-content-area"></div>
        </div>
    </div>
</DashboardLayout>

<!-- Load Toast UI Editor JS properly -->
<script
    is:inline
    src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"
></script>

<script>
    import { supabase } from "../lib/supabase";
    import { userProfile } from "../store/user";

    let editorInstance = null;
    let archivesData = [];
    let currentSort = { field: "date", order: "desc" };

    document.addEventListener("astro:page-load", async () => {
        const currentUser = userProfile.get();

        // Check Permissions
        const canUpload =
            currentUser &&
            (currentUser.role === "admin" ||
                currentUser.is_admin === true ||
                currentUser.is_verified === true);

        if (canUpload) {
            const btn = document.getElementById("openModalBtn");
            if (btn) btn.style.display = "flex";
        }

        // Initialize Editor
        const Editor = window.toastui.Editor;
        if (Editor) {
            editorInstance = new Editor({
                el: document.querySelector("#editor"),
                height: "300px",
                initialEditType: "markdown",
                previewStyle: "vertical",
            });
        }

        // Load Data
        await loadArchives();

        // Event Listeners
        setupEventListeners();
    });

    async function loadArchives() {
        const listEl = document.getElementById("resourceList");
        if (!listEl) return;

        listEl.innerHTML =
            '<p style="text-align:center; padding:2rem;">ë¡œë”© ì¤‘...</p>';

        const { data, error } = await supabase
            .from("archives")
            .select("*")
            .order("created_at", { ascending: false });

        if (error) {
            console.error(error);
            listEl.innerHTML = `
                <div style="text-align:center; color:#ef4444; padding: 2rem;">
                    <p style="font-weight:bold; margin-bottom:0.5rem;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
                    <p style="font-size:0.85rem; opacity:0.8;">ìƒì„¸ ì˜¤ë¥˜: ${error.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}</p>
                    <p style="font-size:0.8rem; margin-top:1rem; color:var(--text-muted);">í…Œì´ë¸”: archives / ì»¬ëŸ¼: *</p>
                </div>
            `;
            return;
        }

        archivesData = data || [];
        renderList(archivesData);
    }

    function renderList(list) {
        const listEl = document.getElementById("resourceList");
        if (!listEl) return;

        if (list.length === 0) {
            listEl.innerHTML =
                '<p style="text-align:center; padding:2rem; color:var(--text-muted);">ë“±ë¡ëœ ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        listEl.innerHTML = list
            .map(
                (item) => `
            <div class="resource-card" data-id="${item.id}">
                <div class="col-cat"><span class="cat-badge">${item.category}</span></div>
                <div class="col-title">${item.title}</div>
                <div class="col-date">${new Date(item.created_at).toLocaleDateString()}</div>
                <div class="col-author">${item.author}</div>
                <div style="text-align:right;">
                    ${item.file_url ? "ğŸ“" : ""}
                </div>
            </div>
        `,
            )
            .join("");

        // Attach Click
        document.querySelectorAll(".resource-card").forEach((card) => {
            card.addEventListener("click", () => openViewer(card.dataset.id));
        });
    }

    function openViewer(id) {
        const item = archivesData.find((d) => String(d.id) === String(id));
        if (!item) return;

        document.getElementById("viewCategory").textContent = item.category;
        document.getElementById("viewTitle").textContent = item.title;
        document.getElementById("viewAuthor").textContent = item.author;
        document.getElementById("viewDate").textContent = new Date(
            item.created_at,
        ).toLocaleDateString();

        const downloadBar = document.getElementById("pdfDownloadBar");
        const downloadLink = document.getElementById("downloadLink");
        const fileUrl = item.file_url;
        const viewerEl = document.getElementById("viewer");

        if (fileUrl) {
            downloadBar.style.display = "flex";
            const { data } = supabase.storage
                .from("resources")
                .getPublicUrl(fileUrl);
            const publicUrl = data.publicUrl;
            downloadLink.href = publicUrl;

            // Use iframe for PDF preview if it's a PDF
            if (fileUrl.toLowerCase().endsWith(".pdf")) {
                viewerEl.innerHTML = `
                    <iframe src="${publicUrl}" width="100%" height="500px" style="border:none; border-radius:8px;"></iframe>
                `;
            } else {
                viewerEl.innerHTML = `<div style="text-align:center; padding:3rem; color:var(--text-muted);">
                    <p>ë¯¸ë¦¬ë³´ê¸°ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œí•˜ì—¬ í™•ì¸í•˜ì„¸ìš”.</p>
                </div>`;
            }
        } else {
            downloadBar.style.display = "none";
            if (item.content_html) {
                viewerEl.innerHTML = item.content_html;
            } else {
                viewerEl.innerHTML =
                    '<p style="text-align:center; padding:2rem; color:var(--text-muted);">í‘œì‹œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            }
        }

        document.getElementById("viewerModal").classList.add("active");
    }

    function setupEventListeners() {
        // Modal Toggles
        document
            .getElementById("openModalBtn")
            ?.addEventListener("click", () => {
                document.getElementById("writeForm").reset();
                editorInstance.setMarkdown("");
                document.getElementById("writeModal").classList.add("active");
            });

        document
            .getElementById("closeWriteModal")
            ?.addEventListener("click", () => {
                document
                    .getElementById("writeModal")
                    .classList.remove("active");
            });

        document
            .getElementById("closeViewerBtn")
            ?.addEventListener("click", () => {
                document
                    .getElementById("viewerModal")
                    .classList.remove("active");
            });

        // Search
        document
            .getElementById("resourceSearch")
            ?.addEventListener("input", (e) => {
                const keyword = e.target.value.toLowerCase();
                const filtered = archivesData.filter(
                    (i) =>
                        i.title.toLowerCase().includes(keyword) ||
                        i.author.toLowerCase().includes(keyword),
                );
                renderList(filtered);
            });

        // Category Filter
        document.querySelectorAll(".cat-filter-item").forEach((btn) => {
            btn.addEventListener("click", () => {
                const val = btn.dataset.value;
                document
                    .getElementById("catFilterBtn")
                    .querySelector("span").textContent = val || "ì „ì²´";
                const filtered = val
                    ? archivesData.filter((i) => i.category === val)
                    : archivesData;
                renderList(filtered);
                document
                    .getElementById("catFilterDropdown")
                    .removeAttribute("open");
            });
        });

        // Sort
        document.querySelectorAll(".sort-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
                const field = btn.dataset.sort;
                let order = btn.dataset.order;

                if (order === "desc") order = "asc";
                else if (order === "asc") order = "none";
                else order = "desc";

                document.querySelectorAll(".sort-btn").forEach((b) => {
                    b.dataset.order = "none";
                    b.classList.remove("active", "asc");
                });

                if (order !== "none") {
                    btn.dataset.order = order;
                    btn.classList.add("active");
                    if (order === "asc") btn.classList.add("asc");
                }

                currentSort = { field, order };
                applySort();
            });
        });
    }

    function applySort() {
        if (currentSort.order === "none") {
            renderList(archivesData);
            return;
        }

        const sorted = [...archivesData].sort((a, b) => {
            let valA = a[currentSort.field];
            let valB = b[currentSort.field];

            if (currentSort.field === "date") {
                valA = new Date(a.created_at).getTime();
                valB = new Date(b.created_at).getTime();
            }

            if (currentSort.order === "asc") {
                return valA > valB ? 1 : -1;
            } else {
                return valA < valB ? 1 : -1;
            }
        });

        renderList(sorted);
    }
</script>
