---
import BaseHead from "../components/BaseHead.astro";
import Sidebar from "../components/Sidebar.astro";
import MobileBottomNav from "../components/MobileBottomNav.astro";
import Icon from "../components/Icon.astro";
import Footer from "../components/Footer.astro"; // Optional: We might simplify footer in dashboard
import PWAInstall from "../components/PWAInstall.astro";
import { ViewTransitions } from "astro:transitions";
import GlossaryModal from "../components/GlossaryModal.astro";
import { SITE_TITLE, SITE_DESCRIPTION } from "../consts";

const { title, description, scale } = Astro.props;
---

<!doctype html>
<html lang="ko">
    <head>
        <BaseHead
            title={title ? `${title} - ${SITE_TITLE}` : SITE_TITLE}
            description={description || SITE_DESCRIPTION}
            scale={scale}
        />
        <ViewTransitions />
        <script is:inline>
            function applyFontSize() {
                const savedSize = localStorage.getItem("fontSize") || "medium";
                document.documentElement.setAttribute(
                    "data-font-size",
                    savedSize,
                );
            }
            applyFontSize();
            document.addEventListener("astro:after-swap", applyFontSize);
        </script>
        <style>
            body {
                margin: 0;
                padding: 0;
                background-color: var(--bg-body);
                min-height: 100vh;
            }
            .dashboard-grid {
                display: grid;
                grid-template-columns: 60px 1fr;
                min-height: 100vh;
            }

            main {
                grid-column: 2; /* Force content to second column */
                min-width: 0; /* Prevent grid blowout */
            }

            .content-area {
                padding: 2rem;
                max-width: 1200px;
                margin: 0 auto;
                width: 100%;
                box-sizing: border-box;
            }

            /* Mobile Header */
            .mobile-header {
                display: none;
                background: #1c1c1c;
                color: white;
                padding: 1rem;
                align-items: center;
                position: sticky;
                top: 0;
                z-index: 40;
            }
            .hamburger {
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0;
                margin-right: 1rem;
            }

            .header-actions {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            @media (max-width: 768px) {
                .dashboard-grid {
                    grid-template-columns: 1fr;
                }
                main {
                    grid-column: 1; /* Reset for mobile */
                }
                .mobile-header {
                    display: flex;
                    justify-content: space-between;
                }
                .content-area {
                    padding: 0.5rem;
                }
                /* Overlay for sidebar when open */
                .sidebar-overlay {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 45;
                }
                .sidebar-overlay.active {
                    display: block;
                }
            }
        </style>
    </head>
    <body>
        <div class="mobile-header">
            <div style="display:flex; align-items:center;">
                <button id="menuBtn" class="hamburger" aria-label="Menu">
                    <Icon name="menu" size="24" />
                </button>
                <span style="font-weight:bold; font-size:1.1rem;"
                    >{SITE_TITLE} 0.1</span
                >
            </div>

            <div class="header-actions">
                <button
                    id="headerGlossaryBtn"
                    style="background:none; border:none; color:white; cursor:pointer;"
                    aria-label="용어 사전"
                >
                    <Icon name="search" size="24" />
                </button>
                <a
                    href="/notifications"
                    style="color:white; position:relative;"
                >
                    <Icon name="bell" size="24" />
                    <span
                        class="global-noti-dot"
                        style="position:absolute; top:0; right:0; width:8px; height:8px; background:#ef4444; border-radius:50%; display:none;"
                    ></span>
                </a>
            </div>
        </div>

        <!-- Sidebar Overlay -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>

        <div class="dashboard-grid">
            <!-- Sidebar (Desktop & Mobile Drawer) -->
            <Sidebar />

            <!-- Main Content -->
            <main transition:animate="slide">
                <div class="content-area">
                    <slot />
                </div>
                <!-- Spacer for Bottom Nav (only if bottom nav exists) -->
                <div style="height: 80px;"></div>
            </main>
        </div>

        <GlossaryModal />
        <MobileBottomNav />
        <PWAInstall />

        <script is:inline>
            // Mobile Menu Toggle
            function initMobileMenu() {
                console.log("Initializing Mobile Menu...");
                const menuBtn = document.getElementById("menuBtn");
                const sidebar = document.querySelector(".sidebar");
                const overlay = document.getElementById("sidebarOverlay");
                const glossaryBtn =
                    document.getElementById("headerGlossaryBtn");

                if (menuBtn && sidebar) {
                    // Remove old listener to avoid duplicates if re-running
                    const newBtn = menuBtn.cloneNode(true);
                    menuBtn.parentNode.replaceChild(newBtn, menuBtn);

                    newBtn.addEventListener("click", () => {
                        console.log("Menu clicked");
                        sidebar.classList.toggle("open");
                        overlay?.classList.toggle("active");
                    });
                }

                if (overlay && sidebar) {
                    // Remove old listener
                    const newOverlay = overlay.cloneNode(true);
                    overlay.parentNode.replaceChild(newOverlay, overlay);

                    newOverlay.addEventListener("click", () => {
                        console.log("Overlay clicked");
                        sidebar.classList.remove("open");
                        newOverlay.classList.remove("active");
                    });
                }

                if (glossaryBtn) {
                    const newGlossaryBtn = glossaryBtn.cloneNode(true);
                    glossaryBtn.parentNode.replaceChild(
                        newGlossaryBtn,
                        glossaryBtn,
                    );

                    newGlossaryBtn.addEventListener("click", () => {
                        document.dispatchEvent(
                            new CustomEvent("open-glossary"),
                        );
                    });
                }
            }

            // Run immediately
            initMobileMenu();

            // Run on ViewTransitions navigation
            document.addEventListener("astro:after-swap", initMobileMenu);
        </script>
        <script>
            import { supabase } from "../lib/supabase";
            import { setUser, clearUser } from "../store/user";
            import { isAdmin } from "../config/auth";

            // Global Auth Listener (Needs to be set once)
            supabase.auth.onAuthStateChange(async (event, session) => {
                console.log("Auth State Change:", event, session?.user?.email);
                updateUserStore(session);
            });

            // Auth Check & Store Sync on every page load (supports View Transitions)
            document.addEventListener("astro:page-load", async () => {
                console.log("Page Load: Checking Auth...");
                const {
                    data: { session },
                } = await supabase.auth.getSession();
                await updateUserStore(session);
            });

            async function updateUserStore(session) {
                const currentPath = window.location.pathname;
                const publicPaths = ["/", "/login"];
                const isPublic = publicPaths.some(
                    (path) =>
                        currentPath === path ||
                        (path !== "/" && currentPath.startsWith(path)),
                );

                if (session?.user) {
                    // 1. Basic Info from Session
                    const baseUser = {
                        id: session.user.id,
                        email: session.user.email || "",
                        full_name:
                            session.user.user_metadata?.full_name ||
                            session.user.user_metadata?.name ||
                            "사용자",
                        avatar_url:
                            session.user.user_metadata?.avatar_url || "",
                        provider:
                            session.user.app_metadata?.provider || "email",
                    };

                    // Check if user is admin based on email
                    const userIsAdmin = isAdmin(baseUser.email);

                    // 2. Fetch Full Profile from DB
                    const { data: profile } = await supabase
                        .from("profiles")
                        .select("*")
                        .eq("id", session.user.id)
                        .single();

                    if (profile) {
                        // If user is admin but DB doesn't reflect it, update DB
                        if (userIsAdmin && !profile.is_admin) {
                            console.log(
                                "Updating is_admin=true in DB for:",
                                baseUser.email,
                            );
                            await supabase
                                .from("profiles")
                                .update({ is_admin: true })
                                .eq("id", session.user.id);
                        }

                        setUser({
                            ...baseUser,
                            ...profile,
                            full_name: profile.full_name || baseUser.full_name,
                            is_admin: userIsAdmin,
                            licenses: profile.licenses || [],
                        });
                        checkNotifications(session.user.id);
                    } else {
                        console.warn(
                            "Fetch Profile Failed (using basic session):",
                            "No profile found for user " + session.user.id,
                        );
                        setUser({ ...baseUser, is_admin: userIsAdmin });
                        checkNotifications(session.user.id);
                    }

                    // Logged in user on /login -> redirect to /mypage
                    if (currentPath === "/login") {
                        window.location.href = "/mypage";
                    }
                } else {
                    clearUser();
                    // Auth Guard: Redirect to login if on a protected page
                    if (!isPublic) {
                        console.log(
                            "Unauthorized access. Redirecting to /login...",
                        );
                        window.location.href = "/login";
                    }
                }
            }

            async function checkNotifications(userId) {
                try {
                    const { count, error } = await supabase
                        .from("notifications")
                        .select("*", { count: "exact", head: true })
                        .eq("user_id", userId)
                        .eq("is_read", false);

                    if (!error) {
                        const dots =
                            document.querySelectorAll(".global-noti-dot");
                        dots.forEach((dot) => {
                            dot.style.display = count > 0 ? "block" : "none";
                        });
                    }
                } catch (e) {
                    console.error("Check Noti Error:", e);
                }
            }
        </script>
    </body>
</html>
