---
import Icon from "./Icon.astro";
import { glossaryTerms } from "../data/glossary";
---

<div id="glossaryModal" class="modal-backdrop" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">
                <Icon name="document-text" size="24" />
                법령 용어 사전
            </h2>
            <button id="closeGlossaryBtn" class="close-btn">
                <Icon name="x" size="24" />
            </button>
        </div>

        <div class="search-box">
            <Icon name="search" size="18" class="search-icon" />
            <input
                type="text"
                id="glossarySearch"
                placeholder="궁금한 용어를 검색해보세요..."
            />
        </div>

        <div class="terms-list" id="termsList">
            {
                glossaryTerms.map((term) => (
                    <div
                        class="term-item"
                        data-term={term.term}
                        data-def={term.definition}
                    >
                        <div class="term-header">
                            <span class="term-name">{term.term}</span>
                            {term.category && (
                                <span class="term-badge">{term.category}</span>
                            )}
                        </div>
                        <p class="term-def">{term.definition}</p>
                    </div>
                ))
            }
        </div>

        <div id="glossaryEmpty" class="empty-state" style="display: none;">
            검색 결과가 없습니다.
        </div>
    </div>
</div>

<style>
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center; /* Desktop Center */
        backdrop-filter: blur(4px);
        padding: 1rem;
    }

    .modal-content {
        background: var(--bg-card);
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border: 1px solid var(--border-color);
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            transform: translateY(20px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: var(--bg-card);
    }

    .modal-title {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--text-main);
    }

    .close-btn {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0.25rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .close-btn:hover {
        color: var(--text-main);
    }

    .search-box {
        padding: 1rem;
        position: relative;
        border-bottom: 1px solid var(--border-color);
    }

    .search-icon {
        position: absolute;
        left: 1.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        pointer-events: none;
    }

    #glossarySearch {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--bg-body);
        color: var(--text-main);
        font-size: 0.95rem;
    }
    #glossarySearch:focus {
        outline: none;
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    .terms-list {
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }

    .term-item {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s;
    }
    .term-item:last-child {
        border-bottom: none;
    }
    .term-item:hover {
        background-color: var(--bg-body);
    }

    .term-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.4rem;
    }

    .term-name {
        font-weight: 700;
        color: var(--text-main);
        font-size: 1rem;
    }

    .term-badge {
        font-size: 0.75rem;
        background: var(--bg-sidebar);
        color: var(--text-muted);
        padding: 2px 8px;
        border-radius: 99px;
        border: 1px solid var(--border-color);
    }

    .term-def {
        margin: 0;
        font-size: 0.9rem;
        color: #4b5563; /* Gray 600 */
        line-height: 1.5;
    }

    /* Dark mode text adjustment */
    :global(.dark) .term-def {
        color: #d1d5db;
    }

    .empty-state {
        padding: 3rem 1rem;
        text-align: center;
        color: var(--text-muted);
    }

    /* Mobile Bottom Sheet Style */
    @media (max-width: 640px) {
        .modal-backdrop {
            align-items: flex-end; /* Bottom Align */
            padding: 0;
        }
        .modal-content {
            border-radius: 16px 16px 0 0;
            max-height: 85vh;
            animation: slideUpMobile 0.3s ease-out;
        }
        @keyframes slideUpMobile {
            from {
                transform: translateY(100%);
            }
            to {
                transform: translateY(0);
            }
        }
    }
</style>

<script>
    function initGlossary() {
        const modal = document.getElementById("glossaryModal");
        const closeBtn = document.getElementById("closeGlossaryBtn");
        const searchInput = document.getElementById(
            "glossarySearch",
        ) as HTMLInputElement;
        const termsList = document.getElementById("termsList");
        const emptyState = document.getElementById("glossaryEmpty");
        const items = document.querySelectorAll(".term-item");

        if (!modal || !closeBtn) return;

        // Open Logic is handled by global event listener dispatched from layout
        document.addEventListener("open-glossary", () => {
            modal.style.display = "flex";
            if (searchInput) {
                searchInput.value = "";
                searchInput.focus();
                filterTerms("");
            }
            document.body.style.overflow = "hidden"; // Prevent background scrolling
        });

        const closeGlossary = () => {
            modal.style.display = "none";
            document.body.style.overflow = "";
        };

        closeBtn.addEventListener("click", closeGlossary);
        modal.addEventListener("click", (e) => {
            if (e.target === modal) closeGlossary();
        });

        // Search Logic
        const filterTerms = (query: string) => {
            let hasVisible = false;
            items.forEach((item: any) => {
                const term = item.dataset.term.toLowerCase();
                const def = item.dataset.def.toLowerCase();
                if (term.includes(query) || def.includes(query)) {
                    item.style.display = "";
                    hasVisible = true;
                } else {
                    item.style.display = "none";
                }
            });

            if (emptyState) {
                emptyState.style.display = hasVisible ? "none" : "block";
            }
        };

        if (searchInput) {
            // Real-time search
            searchInput.addEventListener("input", (e) => {
                const target = e.target as HTMLInputElement;
                filterTerms(target.value.toLowerCase().trim());
            });

            // Handle Enter key
            searchInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault(); // Prevent form submission if any
                    filterTerms(searchInput.value.toLowerCase().trim());
                    // Optional: Blur to hide keyboard on mobile or indicate completion
                    // searchInput.blur();
                }
            });

            // Handle Korean IME composition end
            searchInput.addEventListener("compositionend", (e) => {
                filterTerms(searchInput.value.toLowerCase().trim());
            });
        }
    }

    // Init on load and page transition
    document.addEventListener("astro:page-load", initGlossary);
    if (document.readyState !== "loading") initGlossary();
</script>
